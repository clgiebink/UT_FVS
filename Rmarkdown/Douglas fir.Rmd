---
title: "Linear Mixed Model for Douglas Fir"
author: "Courtney Giebink"
date: "July 31, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
```

## Data Summary

```{r include=FALSE}
load(file = '/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_data_df.Rdata')
load(file = '/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/data_all_df.Rdata')
```

My data comes from the U. S. Forest Service's Interior West - Forest Inventory and Analysis (IW-FIA) program (DeRose, Shaw, and Long 2017). The U.S. Forest Service’s Forest Inventory and Analysis program has established plots across the nation, which they use to collect data on forest stands. Recently, tree rings associated with plots in the Interior West states were discovered in storage. The IW-FIA program merged these two data sources: inventory data and tree-ring data. The data that I will use for my analysis is inventory and tree-ring data for *Pseudotsuga menziesii* (Douglas fir) in Utah. 

```{r echo=FALSE, message=FALSE}
library(maps)
m = map_data('state', region = 'Utah')

ggplot() + 
  geom_polygon( data=m, aes(x=long, y=lat,group=group),colour="black", fill="white" )+
  geom_point(data=data_all_df,aes(x=LON,y=LAT),colour="red")+
  ggtitle("Distribution of Douglas fir")+
  xlab('Longitude')+
  ylab('Latitude')+
  coord_fixed()
```


I was able to extract and calculate annual data for 59 trees between the years of 1958 and 1995. 

```{r eval=FALSE}
#create new dataframe with only variables needed for model
#response: RW, dds
#fixed: SI, ASP, SL, DBH/DIA_C, BAL, CR, CCF, PCCF, climate
#random: TRE_CN, Year
#filter for last 30 years of growth
min(data_all_df$MEASYEAR) #1988 -> 1958

glmm_data_df <- data_all_df %>%
  ungroup() %>%
  dplyr::select(PLT_CN, TRE_CN, RW, dds, Year, DIA_C, LAT,
         SICOND, ASPECT, tASPECT, SLOPE, BAL, CR, CR_fvs, PCCF, CCF, cos, sin,
         ppt_pOct, ppt_pDec, ppt_Jun, ppt_Jul,
         ppt_pJunAug, ppt_pAugOct, ppt_MayJul,
         ppt_pJunNov, ppt_FebJul, wateryr, ppt_pJunSep,
         tmin_Feb, tmax_Jul,
         tmax_JunAug, tmax_pJulSep, tmin_JanMar,
         tmax_JanJun,tmin_JanJun,tmax_FebJul) %>%
  filter(Year >= 1958)

#climate
#total ppt
#1 month: pOct,pDec, Jun, Jul
#3 month: pJun-pAug, pAug-pOct, May-Jul
#6 month + : pNov, Jul, wateryr

#average temp
#1 month: Feb tmin, Jul tmax
#3 month: tmax_Jun-Aug, tmax_pJul-pSep, tmin_Jan-Mar
#6 month + : Jun, Jul
```

My data, `glmm_data_df`, consists of raw radial increment, or ring width value, (`RW`) in mm and annual change in squared inside bark diameter (dds) in inches^2 with corresponding tree, climate, and site variables. Some variables stay constant, such as site index (`SICOND`), aspect (`ASPECT`), and slope (`SLOPE`), while diameter at breast height (`DIA_C`) and crown ratio (CR, CR_fvs) vary annually. In addition, density variables, being basal area of trees larger than the subject tree (`BAL`), crown competition factor on the inventory point (`PCCF`), and stand crown competition factor (`CCF`), vary annually. Significant seasonal precipitation and temperature variables were identified based on tradition dendro analysis tools, using R packages `dplR` and `treeclim` (see `Climate-growth.Rmd`)

## Exploration

It is necessary to explore the dataset to determine if the data complies with model assumptions (Zuur, Ieno, and Elphick 2010).

### Normality

The response variable, annual change in squared inside bark diameter (DDS), is continuous. It will be explained using a linear mixed model.

```{r}
par(mfrow=c(2,2))
hist(glmm_data_df$RW,breaks = 50, 
     main = "Histogram of RW (mm)", xlab = "Increment")
hist(glmm_data_df$dds,breaks = 100,
     main = "Histogram of DDS (in^2)", xlab = "Increment")
hist(log(glmm_data_df$dds),breaks = 100, 
     main = "Histogram of log(DDS)", xlab = "Increment")
```

The distribution of DDS is skewed right, similarly to the distribution of raw radial increment (RW). The Gamma distribution is often used for skewed data, although Gaussian might still be appropriate and easier to interpret. 

```{r}
#Cleveland dotplot
par(mfrow=c(1,2))
dotchart(glmm_data_df$dds)
dotchart(log(glmm_data_df$dds))
```

A log transformation normalizes the distribution of DDS and gets rid of outliers.

### Zeros and Missing Data

There is one missing ring (RW = 0) in the data set. To avoid adding an arbitrarily small number, such as 0.001, to every value in the dataset, we replaced missing rings with the smallest ring width value on the same core. 

There is also 2 trees that have NA values for `SICOND` and several trees that have NA values for `ASPECT`. Trees missing `SICOND` were removed from the analysis. Missing `ASPECT` values were changed to 0.

```{r}
which(glmm_data_df$RW == 0) #missing rings
which(is.na(glmm_data_df$RW))
which(glmm_data_df$tdds ==0)

range_df <- varmt_df_z %>%
  select(TRE_CN,Year) %>%
  group_by(TRE_CN) %>%
  summarise(minyr = min(Year),
            maxyr = max(Year))%>%
  gather("stat","year",-TRE_CN)
ggplot(range_df, aes(year, as.character(TRE_CN))) +
        geom_point(aes(color = stat)) +
   theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  ylab("TRE_CN")
```

My data is unbalanced. Almost all trees have a growth measurement for 1958, but one tree's growth measurements start several years later. In addition, most trees end growth in 1992, but some end in 1993, 1994, or 1995. There are no missing data in between first and last year of growth for each tree, and there are no years of zero growth, indicating a missing ring.

```{r}
varmt_df_z %>% dplyr::select(TRE_CN,Year) %>% group_by(TRE_CN) %>% summarise(n = n())
```


### Random and Fixed Effects

In the linear mixed effects model, tree, stand, and climate variables will be fixed effects and a tree identifier and year of growth will be random effects.

```{r}
length(unique(glmm_data_df$TRE_CN))
length(unique(glmm_data_df$PLT_CN))
```

There are almost as many unique plots as unique trees, so it is not necessary to have plots as a random effect as well.

Tree ID and year are appropriate random effects because selected trees and years are a subset from all the possible selected trees and years (Harrison et al. 2018). Each tree has its own intercept of growth due to factors not considered here, such as genetics, microclimate, etc. Each year has its own intercept of growth due to relatively good or poor conditions not accounted for in temperature and precipitation, such as cloud cover, vapor pressure deficit, etc. Each tree and year might also have its own slope, but convergence on a random slope effect can only occur with an adequate amount of data.

```{r warning=FALSE}
#understanding random effects: TRE_CN
growth_yr_plots_df <- glmm_data_df %>% 
  group_by(TRE_CN) %>%
  do(plots=ggplot(data=.) +
       aes(x=Year, y=RW) + geom_point() + 
       ggtitle(unique(.$TRE_CN)))

par(mfrow=c(2,2))
growth_yr_plots_df$plots[[1]]
growth_yr_plots_df$plots[[2]]
growth_yr_plots_df$plots[[3]]
growth_yr_plots_df$plots[[4]]
#can do more all the way to tree 59
```

```{r warning=FALSE}
#understanding random effects: Year
growth_wateryr_plots_df <- glmm_data_df %>% 
  group_by(Year) %>%
  do(plots=ggplot(data=.) +
       aes(x=wateryr, y=RW) + geom_point() +
       geom_smooth(method = "lm") + ggtitle(unique(.$Year)))

par(mfrow=c(2,2))
growth_wateryr_plots_df$plots[[8]]
growth_wateryr_plots_df$plots[[15]]
growth_wateryr_plots_df$plots[[22]]
growth_wateryr_plots_df$plots[[29]]
#can all years 1958 - 1995
```

A proxy for age (time) is diameter at breast height, which is continuous. As a tree gets older, it grows, puts on biomass, and increases its diameter. While a tree could put on the same amount of biomass each year, the biomass will be stretched over an increasing larger circumference. As such, diameter increment decays as a tree ages, or as diameter at breast height increases. This age trend has been clearly described in tree-ring science. Below is a plot of age (dbh) by my response (incr), which is fit with a linear trend:

```{r}
par(mfrow=c(2,2))
#detrend
ggplot(data = glmm_data_df, aes(x = DIA_C, y = RW)) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

ggplot(data = glmm_data_df, aes(x = DIA_C, y = tdds)) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
#non constant variance

ggplot(data = glmm_data_df, aes(x = DIA_C, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

#log to reduce heteroscedasticity
ggplot(data = glmm_data_df, aes(x = log(DIA_C), y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
#negative relationship
```

Site index is a measure of site quality. It is the estimated height in feet of a tree on the site at a specific age (FIA Database Description and User Guide for Phase 2).

```{r}
ggplot(data = glmm_data_df, aes(x = SICOND, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a postive relationship between growth and site index, meaning growth increases with increasing site quality. There is also relatively constant variance.

Slope is an estimated average at the subplot level, or condition level (FIA Database Description and User Guide for Phase 2).

```{r}
ggplot(data = glmm_data_df, aes(x = SLOPE, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and slope, meaning growth decreases with increasing slope. There is also relatively constant variance.

Basal area of trees larger than the subject tree (BAL) is a calculated covariate at the plot level.

```{r}
ggplot(data = glmm_data_df, aes(x = BAL, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and BAL, and there is decreasing variance.

Crown competition factor is a measure of stand density (Krajicek et al. 1961). Tree values of CCF estimate the percentage of an acre that would be covered by the tree’s crown if the tree were open grown (Dixon 2002). 

Crown competitition factor on the inventory point where the tree is established (PCCF) is a calculated covariate on the plot level.

```{r}
ggplot(data = glmm_data_df, aes(x = PCCF, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and PCCF, and there is relatively constant variance.

Stand crown competition factor (CCF) is a calculated covariate on the plot level. It is a summation of PCCF on the plot.

```{r}
ggplot(data = glmm_data_df, aes(x = CCF, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and CCF. In addition, there is most likely an outlier in the dataset.

Crown ratio (CR/CR_fvs) is the percentage of the length of the tree with healthy foliage (FIA Database Description and User Guide for Phase 2). CR was extracted from the FIA Database for the measure year and copied backwards. CR_fvs was back calculated using the Weibull distribution (Dixon 1985) on a plot level.

```{r}
ggplot(data = glmm_data_df, aes(x = CR, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

ggplot(data = glmm_data_df, aes(x = CR_fvs, y = log(tdds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a positive relationship between growth and CR and relatively constant variance. However, there is a negative relationship between growth and CR_fvs.

Based on the exploration, I will transform the response variable (dds) satisfy assumptions of normality of the response variable. I will also further explore outliers with Cleveland dotplots. Normality and homogeneity will be further checked using the residuals of the final models.


## Model Building

```{r include=FALSE}
library(lme4)
library(lmerTest)
library(MuMIn)
#library(nlme)
#library(glmmTMB)
```

```{r include=FALSE}
load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/varmt_df_z.Rdata")
```

The current large-diameter growth model for the UT variant of FVS is a multiple regression.

* SICOND: species site index on a 50-year age basis
* ASPECT: stand aspect
* SLOPE: stand slop
* DIA_C: tree diameter at breast height
* BAL: total basal area in trees larger than the subject tree
* CR_fvs: tree's live crown ratio expressed as proportion
* PCCF: crown competition factor on the subplot level
* CCF: stand crown competition factor

All the covariates above are significant in the current model for Douglas fir, except DIA_C*^2* and CCF. In the model, the response variable (dds) and diameter at breast height (DIA_C) are log transformed to linearize the relationship. Basal area of larger trees than the subject tree (BAL) and CCF are divided by 100 to encourage model convergence. Below the structure for the current model is applied to annualized data set.

```{r eval=FALSE}
#current growth model with tree ring data (annual)
#dia^2 and ccf insignificant in current lm
lm_df <- lm(log(dds)~
           #tree variables
           I(log(DIA_C))+I(DIA_C^2)+
           CR_fvs+I(CR_fvs^2)+
           #climate
           #competition/density
           I(BAL/100)+PCCF+I(CCF/100)+
           #site variables
           SICOND+SLOPE+I(SLOPE^2)+
           sin+cos,
              data = varmt_df_z)
```

Since there is a lot of unaccounted for variability due to individual tree and year differences, the updated model will be a mixed effects model. A random intercept on Tree ID and Year will be added to account for different baselines. A random slope on DIA_C for each year will serve as a detrending method to reduce the age effect in growth.

For now, I will use `lme4` to fit models. To fit a covariance-variance structure other than compound symmetry, I can use `nlme`. I may also explore the model fit options with `glmmTMB`.

Covariates are standardized, or mean-centered and divided by SD, to encourage model converage, which means there is no need for BAL and CCF to be divided by 100. In addition, the log transformation on DIA_C is problematic because a log of a negative number is impossible. Therefore, the log transformation on DIA_C will be removed.

# Random Effects

```{r}
tre_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+#I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1|TRE_CN),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
tyre_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+#I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
tsyre_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+#I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
anova(tre_df,tyre_df,tsyre_df)
```


# Annual Model of Tree Growth

In FVS, DBH*^2* and CCF not included.

```{r}
#add random effects
#random intercept for each tree
#random intercept for each year
#random slope on DBH for each tree (detrending method)
annual_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+#I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(annual_df)
```

## Model Selection



```{r}
an_al_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    # (1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                   (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_al_df)
AICc(an_al_df)
```

### Collinearity

Using the full model with all the possile covariates, I will test for collinearity between predictors with the `car` package.

```{r echo=FALSE, warning=FALSE,message=FALSE}
library(car)
```

```{r}
vif(an_al_df)
```

A Variance Inflation Factor (VIF) above 3 shows strong collinearity, so no variables are strongly correlated.

```{r}
summary(an_al_df)$coef
```

`CR_fvs`*^2* and `SLOPE`*^2* can be removed based on significance.

# Competition

We can also see what competition variable(s) give the lowest AIC.

```{r}
an_bal_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                    control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_bal_df)
#AICc(an_bal_df)
summary(an_bal_df)$coef
an_ccf_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_ccf_df)
#AICc(an_ccf_df)
summary(an_ccf_df)$coef
an_pccf_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                     #climate
                    #competition/density
                    z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_pccf_df)
#AICc(an_pccf_df)
summary(an_pccf_df)$coef
an_sdi_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_sdi_df)
#AICc(an_sdi_df)
summary(an_sdi_df)$coef
```

The model with `CR_fvs` and `SDI` seems to be the best. Next we'll check which solar radiation parameters are best, if any. We will try substituting `sin` and `cos`, the radiation parameters, for a single solar radiation parameter, such as the Swift's solar radiation potential (1976). Here I will use direct radiation calculated from the package `solrad`.

```{r}
an_mod_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_mod_df)
summary(an_mod_df)$coef
an_mod2_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_mod2_df)
summary(an_mod2_df)$coef
an_rmod_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+
                    #site variables
                    z.SICOND+#z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_rmod_df)
summary(an_rmod_df)$coef
an_red_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_red_df)
summary(an_red_df)$coef
```

No matter what radiation parameters I use, AIC score is the same.

```{r}
an_red_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #z.solrad_MayAug+
                    #random effects
                    # (1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_red_df)
summary(an_red_df)$coef
```

likelihood ratio test for FVS_LOC_CD

```{r}
AIC(an_red_df)
an_red2_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|FVS_LOC_CD/TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_red2_df)
anova(an_red_df,an_red2_df)
```

The null hypothesis is that the reduced model is adequate. There is not sufficient evidence
to reject the null hypothesis (p-value > 0.05). Therefore, we will not use a random effect for forest.


## Constant CR

We can also see what competition variable(s) give the lowest AIC.

```{r}
an_cr_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    #z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                    control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_cr_df)
AICc(an_cr_df)
summary(an_cr_df)$coef
an_bal_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                    control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_bal_df)
AICc(an_bal_df)
summary(an_bal_df)$coef
an_ccf_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_ccf_df)
AICc(an_ccf_df)
summary(an_ccf_df)$coef
an_pccf_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                     #climate
                    #competition/density
                    z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_pccf_df)
AICc(an_pccf_df)
summary(an_pccf_df)$coef
an_sdi_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_sdi_df)
AICc(an_sdi_df)
summary(an_sdi_df)$coef
```

The model with `CR_fvs` and `SDI` seems to be the best. Next we'll check which solar radiation parameters are best, if any. We will try substituting `sin` and `cos`, the radiation parameters, for a single solar radiation parameter, such as the Swift's solar radiation potential (1976). Here I will use direct radiation calculated from the package `solrad`.

```{r}
an_mod_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_mod_df)
summary(an_mod_df)$coef
an_mod2_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_mod2_df)
summary(an_mod2_df)$coef
an_rmod_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.SDI+
                    #site variables
                    z.SICOND+#z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_rmod_df)
summary(an_rmod_df)$coef
an_red_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(an_red_df)
summary(an_red_df)$coef
```


# Annual Model with Climate

A tree's growth response is also influenced by climate, or temperature and precipitation, during the growing season. By annualizing the model with tree rings, climate can be included as a covariate. `ppt_` is the total precipitation over the following monthly range. `tmin/max_` is the average temperature over the following monthly range. Climate variables were chosen based on model AIC score, as well as ability to project into the future (e.g. `wateryr`).

```{r warning=FALSE}
#add climate
#for df, Jun is important
#previous Jun is the most correlated
#with pJun-Aug giving the best AIC
#however a specific seasonal range of precipitation might be hard to predict
#use 16mon pJun-Sep
#better AIC than wateryear
clim_16 <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ #remove log due to standardization
                 z.CR_fvs+I(z.CR_fvs^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.BAL+z.PCCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_16)
```

## Model Selection

```{r}
clim_al_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+I(z.CR_fvs^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.BAL+z.PCCF+#z.CCF+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_al_df)
```

### Collinearity

Using the full model with all the possile covariates, I will test for collinearity between predictors with the `car` package.

```{r}
vif(clim_al_df)
```

There are no parameters above 3, so no need to remove parameters based on collinearity. With VIF scores below 3, the model can be reduced based on significance or importance (coefficient value).

```{r}
summary(clim_al_df)$coef
```

`CR_fvs`*^2* and `SLOPE`*^2* can be removed based on significance.

```{r}
#reduce
#slope^2,CR^2
#test competition
clim_bal_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.BAL+
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_bal_df)
summary(clim_bal_df)$coef
clim_ccf_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_ccf_df)
summary(clim_ccf_df)$coef
clim_sdi_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ 
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_sdi_df)
summary(clim_sdi_df)$coef
```


```{r}
AIC(clim_sdi_df)
summary(clim_sdi_df)$coef
clim_mod_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    z.ppt_pJunSep*z.tmax_FebJul+
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(clim_mod_df)
summary(clim_mod_df)$coef
clim_mod2_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    z.ppt_pJunSep*z.tmax_FebJul+
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(clim_mod2_df)
summary(clim_mod2_df)$coef
clim_rmod_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    z.ppt_pJunSep*z.tmax_FebJul+
                    #competition/density
                    z.SDI+
                    #site variables
                    z.SICOND+#z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(clim_rmod_df)
summary(clim_rmod_df)$coef
clim_red_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    z.ppt_pJunSep*z.tmax_FebJul+
                    #competition/density
                    z.SDI+ 
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
AIC(clim_red_df)
summary(clim_red_df)$coef
```

```{r}
clim_red_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ 
                 #site variables
                 z.SICOND+z.SLOPE+
                 #z.solrad_MayAug+
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_red_df)
summary(clim_red_df)$coef
```

likelihood ratio test for FVS_LOC_CD

```{r}
AIC(clim_red_df)
clim_red2_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ 
                 #site variables
                 z.SICOND+z.SLOPE+
                 #z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|FVS_LOC_CD/TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_red2_df)
anova(clim_red_df,clim_red2_df)
```


### Constant CR

```{r}
clim_al_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+I(z.CR^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.BAL+z.PCCF+z.CCF+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_al_df)
summary(clim_al_df)$coef
```

```{r}
#competition
clim_bal_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_bal_df)
summary(clim_bal_df)$coef
clim_ccf_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.CCF+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_ccf_df)
summary(clim_ccf_df)$coef
clim_pccf_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.PCCF+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_pccf_df)
summary(clim_pccf_df)$coef
clim_sdi_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_sdi_df)
summary(clim_sdi_df)$coef
```


```{r}
AIC(clim_sdi_df)
summary(clim_sdi_df)$coef
clim_mod_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_mod_df)
summary(clim_mod_df)$coef
clim_mod_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+#z.SLOPE+
                 z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_mod_df)
summary(clim_mod_df)$coef
clim_red_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_red_df)
summary(clim_red_df)$coef
```

### Interactions

```{r}
#interactions
clim_mod_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_mod_df)
summary(clim_mod_df)$coef
clim_int_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.DIA_C:z.tmax_FebJul+
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_int_df)
summary(clim_int_df)$coef
clim_int_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 z.SDI:z.ppt_pJunSep+
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_int_df)
summary(clim_int_df)$coef
clim_int_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.SICOND:z.tmax_FebJul+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_int_df)
summary(clim_int_df)$coef
clim_int_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.DIA_C:z.tmax_FebJul+
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 z.SDI:z.ppt_pJunSep+
                 #site variables
                 z.SICOND+z.SLOPE+
                 #z.SICOND:z.tmax_FebJul+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_int_df)
summary(clim_int_df)$coef
```


### Normals

```{r}
clim_n_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep+z.tmax_FebJul+
                 #z.ppt_pJunSep:z.tmax_FebJul+
                 z.n_tmp+ z.n_ppt+
                 z.ppt_pJunSep:z.n_ppt+
                 z.n_tmp:z.tmax_FebJul+
                 z.n_ppt:z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
summary(clim_n_df)$coef
```


```{r}
#normals
clim_mod_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_mod_df)
summary(clim_mod_df)$coef
clim_n_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep+z.tmax_FebJul+
                 #z.ppt_pJunSep:z.tmax_FebJul+
                 #z.n_ppt+
                 z.n_tmp+
                 z.n_ppt:z.ppt_pJunSep+
                 z.n_tmp:z.ppt_pJunSep+
                 z.n_tmp:z.tmax_FebJul+
                 z.n_ppt:z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_n_df)
summary(clim_n_df)$coef
clim_nint_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 #z.DIA_C:z.tmax_FebJul+
                 z.CR+
                 #climate
                 z.ppt_pJunSep+z.tmax_FebJul+
                 #z.ppt_pJunSep:z.tmax_FebJul+
                 #z.n_ppt+
                 z.n_tmp+
                 z.n_ppt:z.ppt_pJunSep+
                 #z.n_tmp:z.ppt_pJunSep+
                 #z.n_tmp:z.tmax_FebJul+
                 z.n_ppt:z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 z.SDI:z.ppt_pJunSep+
                 z.SDI:z.n_ppt+
                 #site variables
                 z.SICOND+z.SLOPE+
                 #z.SICOND:z.tmax_FebJul+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_nint_df)
summary(clim_nint_df)$coef
clim_nint_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.DIA_C:z.tmax_FebJul+
                 z.CR+
                 #climate
                 z.ppt_pJunSep+z.tmax_FebJul+
                 #z.ppt_pJunSep:z.tmax_FebJul+
                 #z.n_ppt+
                 z.n_tmp+
                 z.n_ppt:z.ppt_pJunSep+
                 #z.n_tmp:z.ppt_pJunSep+
                 #z.n_tmp:z.tmax_FebJul+
                 z.n_ppt:z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 z.SDI:z.ppt_pJunSep+
                 z.SDI:z.n_ppt+
                 #site variables
                 z.SICOND+z.SLOPE+
                 #z.SICOND:z.tmax_FebJul+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(clim_nint_df)
summary(clim_nint_df)$coef
```


### Random Slope

```{r}
n_tre_floc <- varmt_df_z %>%
  ungroup() %>%
  dplyr::select(TRE_CN,FVS_LOC_CD) %>%
  distinct() %>%
  group_by(FVS_LOC_CD) %>%
  summarize(n_tre = length(unique(TRE_CN)))
```


```{r}
clim_rs_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                (1+z.ppt_pJunSep|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
anova(clim_red_df,clim_rs_df)
summary(clim_rs_df)
```


## Model Diagnostics

```{r echo=FALSE}
#tree ring model
an_al_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
an_red_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
an_cred_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_df_z)
#tr+climate model
clim_al_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+I(z.CR_fvs^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.BAL+z.PCCF+#z.CCF+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
clim_red_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ 
                 #site variables
                 z.SICOND+z.SLOPE+
                 #z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
clim_cred_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ 
                 #site variables
                 z.SICOND+z.SLOPE+
                 #z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
#normals
clim_n_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep+z.tmax_FebJul+
                 #z.ppt_pJunSep:z.tmax_FebJul+
                 z.n_ppt+z.n_tmp+
                 z.n_ppt:z.ppt_pJunSep+
                 z.n_ppt:z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
clim_nint_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 #z.DIA_C:z.tmax_FebJul+
                 z.CR_fvs+
                 #climate
                 z.ppt_pJunSep+z.tmax_FebJul+
                 z.n_ppt+z.n_tmp+
                 z.n_ppt:z.ppt_pJunSep+
                 z.n_ppt:z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 z.SDI:z.ppt_pJunSep+
                 z.SDI:z.n_ppt+
                 #site variables
                 z.SICOND+z.SLOPE+
                 #z.SICOND:z.tmax_FebJul+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
AIC(an_al_df,an_red_df,clim_al_df,clim_red_df,clim_n_df,clim_nint_df)
```


### Test of Normality

The linear mixed effect model assumes a Gaussian (normal) distribution. To test that assumption, a quantile-quantile (qq) plot will plot our distribution against a normal distribution.


```{r echo=FALSE}
#residuals
par(mfrow=c(2,2))

#full annual
resid_an<- residuals(an_al_df,type="pearson",scaled=TRUE)
qqnorm(resid_an,main="QQ plot of Full Annual")
qqline(resid_an)
hist(resid_an, breaks = 50, main = "Histogram of Full Annual Residuals")

#annual reduced
resid_anred <- residuals(an_cred_df,type="pearson",scaled=TRUE)
qqnorm(resid_anred,main="QQ plot of Reduced Annual")
qqline(resid_anred)
hist(resid_anred, breaks = 50, main = "Histogram of Reduced Annual Residuals")

#full climate
resid_clm<- residuals(clim_al_df,type="pearson",scaled=TRUE)
qqnorm(resid_clm,main="QQ plot of Full Climate")
qqline(resid_clm)
hist(resid_clm, breaks = 50, main = "Histogram of Full Climate Residuals")

#reduced climate
resid_clmred <- residuals(clim_cred_df,type="pearson",scaled=TRUE)
qqnorm(resid_clmred,main="QQ plot of Reduced Climate")
qqline(resid_clmred)
hist(resid_clmred, breaks = 50, main = "Histogram of Reduced Climate Residuals")

#climate normals
resid_clmn <- residuals(clim_n_df,type="pearson",scaled=TRUE)
qqnorm(resid_clmn,main="QQ plot of Reduced Climate Normals")
qqline(resid_clmn)
hist(resid_clmn, breaks = 50, main = "Histogram of Reduced Climate Normal Residuals")

#climate normals + interactions
resid_clmnint <- residuals(clim_nint_df,type="pearson",scaled=TRUE)
qqnorm(resid_clmnint,main="QQ plot of Normals + Interactions")
qqline(resid_clmnint)
hist(resid_clmnint, breaks = 50, main = "Histogram of Normals + Interactions Residuals")

```

### Test of Homoscedasticity

```{r include=FALSE}
library(gplots)
```

To test if my transformed residuals have a constant variance with a mean of zero, I will plot transformed residuals vs predicted values.

```{r}
par(mfrow=c(2,2))
pred_an <- predict(an_al_df, type="response")
plotLowess(resid_an~pred_an, ylab="Residuals",xlab="Predicted", main="Full Annual")
pred_anred <- predict(an_cred_df, type="response")
plotLowess(resid_anred~pred_anred, ylab="Residuals",xlab="Predicted", main="Reduced Annual")
pred_clm <- predict(clim_al_df, type="response")
plotLowess(resid_clm~pred_clm, ylab="Residuals",xlab="Predicted", main="Full Climate")
pred_clmred <- predict(clim_cred_df, type="response")
plotLowess(resid_clmred~pred_clmred, ylab="Residuals",xlab="Predicted", main="Reduced Climate")
pred_clmn <- predict(clim_n_df, type="response")
plotLowess(resid_clmn~pred_clmn, ylab="Residuals",xlab="Predicted", main="Reduced Climate w/ Normals")
pred_clmnint <- predict(clim_nint_df, type="response")
plotLowess(resid_clmnint~pred_clmnint, ylab="Residuals",xlab="Predicted", main="Normals + interactions")
```

We can also test if residuals have a constant variance against predictor variables. Below plots are only given for the reduced climate model, but more models can be plotted.

```{r echo=FALSE}
par(mfrow=c(2,2))
#dbh
plotLowess(resid_clmred~z.DIA_C,data = varmt_df_z,ylab="Residuals",main="Climate Reduced: DBH")
#plotLowess(resid_lmm1~z.DIA_C,data = varmt_df_z,ylab="Residuals",main="LMM1")
#CR
plotLowess(resid_clmred~z.CR_fvs,data = varmt_df_z,ylab="Residuals",main="Climate Reduced: CR")
#plotLowess(resid_lmm1~z.CR_fvs,data = varmt_df_z,ylab="Residuals",main="LMM1")
#precip
plotLowess(resid_clmred~z.ppt_pJunAug,data = varmt_df_z,ylab="Residuals",main="Climate Reduced: Precip") 
#plotLowess(resid_lmm1~z.ppt_pJunAug,data = varmt_df_z,ylab="Residuals",main="LMM1") 
#temp
plotLowess(resid_clmred~z.tmax_FebJul,data = varmt_df_z,ylab="Residuals",main="Climate Reduced: Temp")
#plotLowess(resid_lmm1~z.tmax_FebJul,data = varmt_df_z,ylab="Residuals",main="LMM1")
#CCF
plotLowess(resid_clmred~z.CCF,data = varmt_df_z,ylab="Residuals",main="Climate Reduced: CCF")
#plotLowess(resid_lmm1~z.CCF,data = varmt_df_z,ylab="Residuals",main="LMM1")
#SI
plotLowess(resid_clmred~z.SICOND,data = varmt_df_z,ylab="Residuals",main="Climate Reduced: SI")
#plotLowess(resid_lmm1~z.SICOND,data = varmt_df_z,ylab="Residuals",main="LMM1")
#Slope
plotLowess(resid_clmred~z.SLOPE,data = varmt_df_z,ylab="Residuals",main="Climate Reduced: Slope")
#plotLowess(resid_lmm1~z.SLOPE,data = varmt_df_z,ylab="Residuals",main="LMM1")
```

### Mining

```{r}
#reduced models
#BALIVE


```

```{r}
ggplot(data = varmt_df_z, aes(x = z.SDI, y = z.n_ppt)) +
  geom_point() +
  theme_bw() +
  labs(x = "SDI", y = "MAP")
```



## Visualization

```{r include=FALSE}
library(broom.mixed)
library(dotwhisker)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
full_an_df <-  tidy(an_al_df) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Full Annual")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.BAL = "BAL",
                       z.CCF = "CCF",
                       z.PCCF = "PCCF",
                       z.SDI = "SDI",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL"))
red_an_df <-  tidy(an_red_df) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Reduced Annual")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       z.CR = "CR",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL",
                       z.solrad_MayAug = "solrad"))
full_clim_df <-  tidy(clim_al_df) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Full Climate")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.ppt_pJunSep = "Precip",
                       z.tmax_FebJul = "Temp",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Precip:Temp",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.PCCF = "PCCF",
                       z.SDI = "SDI",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL"))
red_clim_df <-  tidy(clim_red_df) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Reduced Climate")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.ppt_pJunSep = "Precip",
                       z.tmax_FebJul = "Temp",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Precip:Temp",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL",
                       z.solrad_MayAug = "solrad"))
red_n_df <-  tidy(clim_n_df) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Climate Normals")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.ppt_pJunSep = "Precip",
                       z.tmax_FebJul = "Temp",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Precip:Temp",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL",
                       z.solrad_MayAug = "solrad",
                       z.n_ppt = "Precip Normal",
                       z.n_tmp = "Temp Normal",
                       "z.ppt_pJunSep:z.n_ppt" = "Precip:Precip Normal",
                       "z.tmax_FebJul:z.n_ppt" = "Temp:Precip Normal",
                       "z.tmax_FebJul:z.n_tmp" = "Temp:Temp Normal"))
red_nint_df <-  tidy(clim_nint_df) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Normals + Interactions")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.ppt_pJunSep = "Precip",
                       z.tmax_FebJul = "Temp",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL",
                       z.solrad_MayAug = "solrad",
                       z.n_ppt = "Precip Normal",
                       z.n_tmp = "Temp Normal",
                       "z.ppt_pJunSep:z.n_ppt" = "Precip:Precip Normal",
                       "z.tmax_FebJul:z.n_ppt" = "Temp:Precip Normal",
                       "z.ppt_pJunSep:z.SDI" = "Precip:SDI",
                       "z.n_ppt:z.SDI" = "Precip Normal:SDI"))
models_df <- full_join(full_an_df,red_an_df) %>%
  full_join(.,full_clim_df) %>%
  full_join(.,red_clim_df) %>%
  full_join(.,red_n_df) %>%
  full_join(.,red_nint_df)
df_mods <- dwplot(models_df, dodge_size = 1,
                  vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
                  # plot line at zero _behind_ coefs
                  dot_args = list(aes(shape = model)))+
                  #whisker_args = list(aes(linetype = model))) +
                  theme_bw() + xlab("Standardized Coefficient Estimate") + ylab("") +
                    theme(plot.title = element_text(face="bold"),
                          legend.position = "right",
                          legend.background = element_rect(colour="grey80"),
                          legend.title.align = 0.5)
#change shapes
models_df <- models_df %>% filter(term != "(Intercept)") %>% droplevels()
models_df$model <- factor(models_df$model, levels = c("Full Annual", "Reduced Annual", "Full Climate",
                                                      "Reduced Climate", "Climate Normals","Normals + Interactions"))
df_mods <- ggplot(data = models_df, aes(x = term, y = estimate, shape = model)) + 
  geom_linerange(aes(ymax = estimate + std.error, ymin = estimate - std.error), 
                position = position_dodge(width = 1), color = "grey58") +
  geom_point(position = position_dodge(width = 1), size = 2) +
  scale_shape_manual(values=c(16,1,17,2,3,8)) +# change shape
  scale_x_discrete(limits = rev(levels(models_df$term))) +
  geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  coord_flip() +
  theme_bw() + labs(title = "a)", y = "Standardized Coefficient Estimate", x="Predictor") +
  theme(#plot.title = element_text(face="bold"),
        legend.position = c(0.76,0.5),
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)

ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/df_mods.png",
       height = 10, width = 6, units = "in")
```


## Interpretation

We can start to understand the influence of the covariate on the response variable, tree growth, with the `effects` package. Keeping all other variables constant, it shows the effect of the covariate on the reponse.

```{r include=FALSE}
library(grid)
library(gridExtra)
library(effects)
library(sjPlot)
library(sjmisc)
```

### Diameter at Breast Height

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.DIA_C",annual_df),xlab = "DBH",main = "Full Annual")
plot(effect("z.DIA_C",an_red_df),xlab = "DBH",main = "Reduced Annual")
plot(effect("z.DIA_C",clim_16),xlab = "DBH",main = "Full Climate")
plot(effect("z.DIA_C",clim_red_df),xlab = "DBH",main = "Reduced Climate")
```

### Crown Ratio

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.CR_fvs",annual_df),xlab = "Crown Ratio",main = "Full Annual")
plot(effect("z.CR_fvs",an_red_df),xlab = "Crown Ratio",main = "Reduced Annual")
plot(effect("z.CR_fvs",clim_16),xlab = "Crown Ratio",main = "Full Climate")
plot(effect("z.CR_fvs",clim_red_df),xlab = "Crown Ratio",main = "Reduced Climate")
```

### Site Index

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.SICOND",annual_df),xlab = "Site Index",main = "Full Annual")
plot(effect("z.SICOND",an_red_df),xlab = "Site Index",main = "Reduced Annual")
plot(effect("z.SICOND",clim_16),xlab = "Site Index",main = "Full Climate")
plot(effect("z.SICOND",clim_red_df),xlab = "Site Index",main = "Reduced Climate")
```

### Slope

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.SLOPE",annual_df),xlab = "Slope",main = "Full Annual")
plot(effect("z.SLOPE",an_red_df),xlab = "Slope",main = "Reduced Annual")
plot(effect("z.SLOPE",clim_16),xlab = "Slope",main = "Full Climate")
plot(effect("z.SLOPE",clim_red_df),xlab = "Slope",main = "Reduced Climate")
```

### Radiation

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.sin",annual_df),xlab = "sin(Aspect-0.7854)*Slope",main = "Full Annual")
plot(effect("z.sin",clim_16),xlab = "sin(Aspect-0.7854)*Slope",main = "Full Climate")
plot(effect("z.cos",annual_df),xlab = "cos(Aspect-0.7854)*Slope",main = "Full Annual")
plot(effect("z.cos",clim_16),xlab = "cos(Aspect-0.7854)*Slope",main = "Full Climate")

```

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.solrad_MayAug",an_red_df),xlab = "solrad",main = "Reduced Annual")
plot(effect("z.solrad_MayAug",clim_red_df),xlab = "solrad",main = "Reduced Climate")
```

### Climate

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(1,2))
plot(effect("z.ppt_pJunSep",clim_16),xlab = "Precipitation",main = "Full Climate")
plot(effect("z.ppt_pJunSep",clim_16_red),xlab = "Precipitation",main = "Reduced Climate")
plot(effect("z.tmax_FebJul",clim_16),xlab = "Temperature",main = "Full Climate")
plot(effect("z.tmax_FebJul",clim_16_red),xlab = "Temperature",main = "Reduced Climate")
```
```{r echo=FALSE}
plot(effect("z.ppt_pJunSep:z.tmax_FebJul",clim_16),xlab = "Interaction",main = "Full Climate")
plot(effect("z.ppt_pJunSep:z.tmax_FebJul",clim_16_red),xlab = "Interaction",main = "Reduced Climate")
```

### All

```{r}
d <- plot(effect("z.DIA_C",clim_cred_df),xlab = "DBH",main="")
c <- plot(effect("z.CR",clim_cred_df),xlab = "Crown Ratio",main="")
sdi <- plot(effect("z.SDI",clim_cred_df),xlab = "SDI",main="")
si <- plot(effect("z.SICOND",clim_cred_df),xlab = "Site Index",main="")
sl <- plot(effect("z.SLOPE",clim_cred_df),xlab = "Slope",main="")
ppt <- plot(effect("z.ppt_pJunSep",clim_n_df),xlab = "Precipitation",main="")
tmp <- plot(effect("z.tmax_FebJul",clim_n_df),xlab = "Temperature",main="")
all_coef <- arrangeGrob(d,c,sdi,si,sl,ppt,tmp,nrow=3)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/eff_df.png", all_coef)
```

### Interaction

```{r}
#plot interaction across whole range
clint <- plot_model(clim_red_df, type = "pred", terms = c("z.ppt_pJunSep","z.tmax_FebJul"),
                    axis.title = c("Precip","dds"), title = "b) Temp", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  geom_rug(data = varmt_df_z, aes(x = z.ppt_pJunSep), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
nint1 <- plot_model(clim_n_df, type = "pred", terms = c("z.ppt_pJunSep","z.n_ppt"),
                    axis.title = c("Precip","dds"), title = "c) Precip Normal", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  geom_rug(data = varmt_df_z, aes(x = z.ppt_pJunSep), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
nint2 <- plot_model(clim_n_df, type = "pred", terms = c("z.tmax_FebJul","z.n_ppt"),
                    axis.title = c("Temp","dds"), title = "d) Precip Normal", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  geom_rug(data = varmt_df_z, aes(x = z.tmax_FebJul), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
nint3 <- plot_model(clim_nint_df, type = "pred", terms = c("z.ppt_pJunSep","z.SDI"),
                    axis.title = c("Precip","dds"), title = "e) SDI", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  geom_rug(data = varmt_df_z, aes(x = z.ppt_pJunSep), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
nint4 <- plot_model(clim_nint_df, type = "pred", terms = c("z.SDI","z.n_ppt"),
                    axis.title = c("SDI","dds"), title = "f) Precip Normal", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  geom_rug(data = varmt_df_z, aes(x = z.SDI), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
all_int <- grid.arrange(clint,nint1,nint2,nint3,nint4,ncol = 2)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/eff_int_df.png", all_int, scale = .5)

#presentation
prec_sdi <- plot_model(clim_nint_df, type = "pred", terms = c("z.ppt_pJunSep","z.SDI"),
                    axis.title = c("Interannual Precipitation","dds"),
                    colors = c("#3366FF", "#660099", "#CC0000")) +
  theme_bw()
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/prec_sdi.png", prec_sdi, 
       width = 5, height = 4, units = "in")
n_sdi <- plot_model(clim_nint_df, type = "pred", terms = c("z.SDI","z.n_ppt"),
                    axis.title = c("Competition","dds"),
                    colors = c("#CC0000", "#660099", "#3366FF")) +
  theme_bw()
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/n_sdi.png", n_sdi,
       width = 5, height = 4, units = "in")

#all together
plot_df <- list(df_mods,clint,nint1,nint2,nint3,nint4)
lay = rbind(c(1,1,2,3),
             c(1,1,4,5),
             c(1,1,6,7))
df_plot <- grid.arrange(grobs = plot_df, layout_matrix = lay)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/df_coef.png", df_plot, 
       height = 8, width = 12, units = "in")
```

```{r}
#consider other options for visualizing interactions
#add rug
plot_model(clim_n_df, type = "pred", terms = c("z.ppt_pJunSep","z.n_ppt"),
                    axis.title = c("Precip","dds"), title = "Precip Normal", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  xlim(-2.5,7) + ylim(1,10) +
  geom_rug(data = varmt_df_z, aes(x = z.ppt_pJunSep), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
#color rug by other variable
library(ggnewscale)
plot_model(clim_n_df, type = "pred", terms = c("z.ppt_pJunSep","z.n_ppt"),
                    axis.title = c("Precip","dds"), title = "c) Precip Normal", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")")))+ 
  new_scale_color() + 
  geom_rug(data = varmt_df_z, aes(x = z.ppt_pJunSep, 
                                    group = z.n_ppt, color = z.n_ppt),
           inherit.aes = FALSE,
           alpha = 0.1, sides = "b") +
  scale_color_gradient(low = "red", high = "blue") +
  labs(color = "Precip Normal")
  
```

```{r}
#add rectangle around 95% confidence interval
nint1 <- plot_model(clim_n_df, type = "pred", terms = c("z.ppt_pJunSep","z.n_ppt"),
                    axis.title = c("Precip","dds"), title = "Precip Normal", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  xlim(-2.5,7) + ylim(1,10) +
    geom_rect(
    aes(xmin = -2, xmax = 2, ymin = -Inf, ymax = Inf),
    size = .5, fill = "#00000000", color = "black")
#scatter plot
ggplot(data = varmt_df_z, aes(x = z.ppt_pJunSep, y = z.n_ppt)) +
  geom_point() + labs(x = "Precip", y = "Precip Normal") +
  theme_bw()
#shows strong correlation
#consider frequency plot below
dens1 <- ggplot(data = varmt_df_z, aes(x = z.ppt_pJunSep)) +
  geom_density() + theme_bw() + xlim(-2.5, 7) + labs(x = "Precip")
#or histogram
hist1 <- ggplot(data = varmt_df_z, aes(x = z.ppt_pJunSep)) +
  geom_histogram() + theme_bw() + #xlim(-2.5, 7) + 
  labs(x = "Precip")+
    geom_rect( # HERE IS UR BOX
    #data = data.frame(),
    aes(xmin = -2, xmax = 2, ymin = -Inf, ymax = Inf),
    size = 1, fill = "#00000000", color = "black")
```


```{r}
#try using the effects package
library(effects)
ef_pdf <- effect("z.ppt_pJunSep*z.n_ppt", clim_n_df, KR = T)
#built in plot
plot(ef_pdf)
#make my own plot
ef.pdf <- as.data.frame(ef_pdf)
cc <- scales::seq_gradient_pal("red", "blue", "Lab")(seq(0,1,length.out=5))
ggplot(ef.pdf, aes(x = z.ppt_pJunSep, color = factor(z.n_ppt))) +
  geom_line(aes(y = fit, group = factor(z.n_ppt)), size = 1.5) +
  geom_ribbon(aes(ymin=lower, ymax=upper, group = factor(z.n_ppt), fill = factor(z.n_ppt)), 
              linetype= "dashed", alpha=0.1, size = 0.5,
              show.legend = F) +
  labs(x = "Interannual Precipitation", y = "Marginal Effects on dds") +
  scale_colour_manual(values = cc) +
  labs(color='Precip Normal') + 
  theme_bw()
```

```{r}
#plot_model relies on ggeffects so use that to make own function
plot_int <- function(data,term1,term2,model){
  require(tidyverse) #obvi
  require(MKmisc) #to get CI
  require(ggeffects) #to predict interaction effect
  
  #find the 95% confidence intervals for 25, 50, 75 percent quantiles
  t2 <- data[,term2]
  #ci10_df <- quantileCI(t2, prob = 0.1)
  ci25_df <- quantileCI(t2, prob = 0.25)
  ci50_df <- quantileCI(t2, prob = 0.50)
  ci75_df <- quantileCI(t2, prob = 0.75)
  #ci90_df <- quantileCI(t2, prob = 0.90)
  #consider adding more quantiles
  
  #make new dataframe
  df <- data.frame(quant = c(25,50,75),
                   estimate = c(ci25_df$estimate[1],ci50_df$estimate[1],
                                ci75_df$estimate[1]),
                   CIlower = c(min(ci25_df$conf.int),min(ci50_df$conf.int),
                               min(ci75_df$conf.int)),
                   CIupper = c(max(ci25_df$conf.int),max(ci50_df$conf.int),
                               max(ci75_df$conf.int)))
  
  #find the values of the first term that are observed between CI above
  for(i in 1:nrow(df)){
    df_red <- data %>% filter(between(t2,df$CIlower[i],df$CIupper[i]))
    t1 <- df_red[,term1]
    df$xmin[i] <- min(t1, na.rm = T)
    df$xmax[i] <- max(t1, na.rm = T)
  }
  
  #create string to pass to predict function
  #first interaction term
  x_l <- c(df$xmin,df$xmax) #list
  x_s <- paste0(x_l, collapse=",") #string
  pred_t1 <- paste0(term1, " [", x_s, "]")
  #second interaction term
  estimate <- paste0(df$estimate, collapse=",")
  pred_t2 <- paste0(term2," [", estimate, "]")
  
  #predict interaction
  int_df <- ggpredict(model, terms = c(pred_t1, pred_t2))
  
  #interaction where observations exist
  df$group <- factor(df$estimate)
  int_df_red <- int_df %>%
    full_join(.,df) %>% #join dfs to filter by observations
    filter(x >= (xmin-0.01) & x <= (xmax+0.01)) #probably should be a better way to do this
  #for example x == xmin |(OR) x == xmax but that doesn't work
  #so subtract/add a little to make work
  
  plot <- ggplot(int_df_red, aes(x = x, y = predicted, color = group)) +
    geom_line() +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), linetype = 0, alpha = 0.2) +
    scale_color_manual(labels = c(25, 50, 75), values = c("grey72", "gray47", "gray0")) +
    theme_bw()+
    labs(y = expression(paste("dds (i", n^2, ")")),
         color = "Quantile")
  
  return(plot)
}

clint_plt <- plot_int(data = varmt_df_z, term1 = "z.ppt_pJunSep", term2 =  "z.tmax_FebJul", model = clim_red_df)
clint_plt <- clint_plt +
  labs(x = "Precip", title = "b) Temp") +
  theme(legend.position = "none")

nint1_plt <- plot_int(data = varmt_df_z, term1 = "z.ppt_pJunSep", term2 = "z.n_ppt", model = clim_n_df)
nint1_plt <- nint1_plt +
    labs(x = "Precip",  title = "c) Precip Normal") +
  theme(legend.position = "none")

nint2_plt <- plot_int(data = varmt_df_z, term1 = "z.tmax_FebJul", term2 = "z.n_ppt", model = clim_n_df) 
nint2_plt <- nint2_plt +
    labs(x = "Temp",  title = "d) Precip Normal") +
  theme(legend.position = "none")

nint3_plt <- plot_int(data = varmt_df_z, term1 = "z.ppt_pJunSep", term2 = "z.SDI", model = clim_nint_df) 
nint3_plt <- nint3_plt +
    labs(x = "Precip",  title = "e) SDI") +
  theme(legend.position = "none")

nint4_plt <- plot_int(data = varmt_df_z, term1 = "z.SDI", term2 = "z.n_ppt", model = clim_nint_df) 
#need one figure with legend to cut and paste
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/int_leg.png",nint4_plt)
nint4_plt <- nint4_plt +
    labs(x = "SDI",  title = "f) Precip Normal") +
  theme(legend.position = "none")

all_int <- grid.arrange(clint_plt,nint1_plt,nint2_plt,
                        nint3_plt,nint4_plt,ncol = 2)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/eff_int_df.png", all_int, scale = .5)

#join interactions with coefficient plot
plot_df <- list(df_mods,clint_plt,nint1_plt,
                nint2_plt,nint3_plt,nint4_plt)
lay = rbind(c(1,1,2,3),
             c(1,1,4,5),
             c(1,1,6,7))
df_plot <- grid.arrange(grobs = plot_df, layout_matrix = lay)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/df_coef.png", df_plot, 
       height = 8, width = 12, units = "in")

```


```{r}
varmt_df_z$pred <- predict(clim_mod_df)
ggplot(varmt_df_z,aes(z.DIA_C,dds))+
     geom_line(colour="gray",aes(y=pred,group=TRE_CN))
```

### Random Effects

```{r}
plot_model(clim_rs_df, type = "re")
```

```{r}
sample_tre <- sample(varmt_df_z$TRE_CN, size = 9)
pp1 <- ggpredict(clim_mod_df,
       terms=c("z.DIA_C","TRE_CN [sample_tre]"), type="random")
plot(pp1)
pp2 <- ggpredict(clim_rs_df,
       terms=c("z.DIA_C","TRE_CN [sample_tre]"), type="random")
plot(pp2)
```


```{r}
pp1 <- ggpredict(clim_mod_df,
       terms=c("z.ppt_pJunSep","TRE_CN [sample_tre]"), type="random")
plot(pp1)
pp2 <- ggpredict(clim_rs_df,
       terms=c("z.ppt_pJunSep","TRE_CN [sample_tre]"), type="random")
plot(pp2)
```

