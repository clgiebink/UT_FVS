---
title: "Linear Mixed Model for Engelmann Spruce"
author: "Courtney Giebink"
date: "August 14, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
```

## Data Summary

```{r include=FALSE}
load(file = '/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_es_z.Rdata')
```

My data comes from the U. S. Forest Service's Interior West - Forest Inventory and Analysis (IW-FIA) program (DeRose, Shaw, and Long 2017). The U.S. Forest Service’s Forest Inventory and Analysis program has established plots across the nation, which they use to collect data on forest stands. Recently, tree rings associated with plots in the Interior West states were discovered in storage. The IW-FIA program merged these two data sources: inventory data and tree-ring data. The data that I will use for my analysis is inventory and tree-ring data for *Picea engelmannii* (Engelmann Spruce) in Utah. 

```{r echo=FALSE, message=FALSE}
library(maps)
m = map_data('state', region = 'Utah')

ggplot() + 
  geom_polygon( data=m, aes(x=long, y=lat,group=group),colour="black", fill="white" )+
  geom_point(data=glmm_es_z,aes(x=LON,y=LAT),colour="red")+
  ggtitle("Distribution of Engelmann spruce")+
  xlab('Longitude')+
  ylab('Latitude')+
  coord_fixed()
```


I was able to extract and calculate annual data for 26 trees between the years of 1962 and 1994. 

```{r eval=FALSE}
#create new dataframe with only variables needed for model
#response: RW, dds
#fixed: SI, ASP, SL, DBH/DIA_C, BAL, CR, CCF, PCCF, climate
#random: TRE_CN, Year
#filter for last 30 years of growth
min(data_all_es$MEASYEAR) #1992 -> 1962

glmm_data_es <- data_all_es %>%
  dplyr::select(PLT_CN,TRE_CN, RW, dds, Year, DIA_C, 
         SICOND, ASPECT, tASPECT, SLOPE, BAL, CR, CR_fvs, PCCF, CCF, cos, sin,
         ppt_Jul, ppt_Apr,
         ppt_pJunAug, ppt_JunAug, ppt_pJulSep, ppt_pOctDec,
         ppt_pJunNov, wateryr, ppt_pAugJul, ppt_pJunSep,
         tmax_pAug, tmin_Feb, tmin_Mar,
         tmin_FebApr, tmax_pJulSep, tmin_JanMar, tmax_FebApr,
         tmin_pNovApr, tmax_pNovApr) %>%
  filter(Year >= 1962)

#climate
#total ppt
#1 month: Jul, Apr
#3 month: pJun-pAug, Jun-Aug, pJul-pSep, pOct-pDec
#6 month + : pNov, wateryr

#average temp
#1 month: tmax_pAug, Feb, Mar
#3 month: tmin_Feb-Apr, tmax_pJul-pSep, tmin_Jan-Mar
#6 month + : tmin_Apr
```

My data, `glmm_data_es`, consists of raw radial increment, or ring width value, (`RW`) in mm and annual change in squared inside bark diameter (dds) in inches^2 with corresponding tree, climate, and site variables. Some variables stay constant, such as site index (`SICOND`), aspect (`ASPECT`), and slope (`SLOPE`), while diameter at breast height (`DIA_C`) and crown ratio (CR, CR_fvs) vary annually. In addition, density variables, being basal area of trees larger than the subject tree (`BAL`), crown competition factor on the inventory point (`PCCF`), and stand crown competition factor (`CCF`), vary annually. Significant seasonal precipitation and temperature variables were identified based on tradition dendro analysis tools, using R packages `dplR` and `treeclim` (see `Climate-growth.Rmd`)


## Exploration

It is necessary to explore the dataset to determine if the data complies with model assumptions (Zuur, Ieno, and Elphick 2010).

### Normality

The response variable, annual change in squared inside bark diameter (DDS), is continuous. It will be explained using a linear mixed model.

```{r}
par(mfrow=c(2,2))
hist(glmm_es_z$RW,breaks = 50, 
     main = "Histogram of RW (mm)", xlab = "Increment")
hist(glmm_es_z$dds,breaks = 100,
     main = "Histogram of DDS (in^2)", xlab = "Increment")
hist(log(glmm_es_z$dds),breaks = 100, 
     main = "Histogram of log(DDS)", xlab = "Increment")
```

The distribution of DDS is hightly skewed right, while the distribution of raw radial increment (RW) is only slightly skewed right. The Gamma distribution is often used for skewed data, although Gaussian might still be appropriate and easier to interpret. 

```{r}
#Cleveland dotplot
par(mfrow=c(1,2))
dotchart(glmm_es_z$dds)
dotchart(log(glmm_es_z$dds))
```

A log transformation normalizes the distribution of DDS and gets rid of a majority of the outliers.

### Zeros and Missing Data

There is one missing ring (RW = 0) in the data set. To avoid adding an arbitrarily small number, such as 0.001, to every value in the dataset, we replaced missing rings with the smallest ring width value on the same core. 

```{r}
length(which(glmm_es_z$RW == 0)) #missing rings
which(is.na(glmm_es_z$RW)) 
which(glmm_es_z$dds ==0)

range_df <- glmm_es_z %>%
  select(TRE_CN,Year) %>%
  group_by(TRE_CN) %>%
  summarise(minyr = min(Year),
            maxyr = max(Year))%>%
  gather("stat","year",-TRE_CN)
ggplot(range_df, aes(year, as.character(TRE_CN))) +
        geom_point(aes(color = stat)) +
   theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  ylab("TRE_CN")
```

My data is unbalanced. All trees have a growth measurement for 1962, but the last year of growth is not the same for all trees. Some trees end growth in 1992, but some end in 1993 or 1994. There are no missing data in between first and last year of growth for each tree, and there is one year of zero growth for one tree, indicating a missing ring.

### Random and Fixed Effects

In the linear mixed effects model, tree, stand, and climate variables will be fixed effects and a tree identifier and year of growth will be random effects.

```{r}
length(unique(glmm_es_z$TRE_CN))
length(unique(glmm_es_z$PLT_CN))
```

There are almost as many unique plots as unique trees, so it is not necessary to have plots as a random effect as well.

Tree ID and year are appropriate random effects because selected trees and years are a subset from all the possible selected trees and years (Harrison et al. 2018). Each tree has its own intercept of growth due to factors not considered here, such as genetics, microclimate, etc. Each year has its own intercept of growth due to relatively good or poor conditions not accounted for in temperature and precipitation, such as cloud cover, vapor pressure deficit, etc. Each tree and year might also have its own slope, but convergence on a random slope effect can only occur with an adequate amount of data.

```{r}
#understanding random effects: TRE_CN
growth_yr_plots_es <- glmm_es_z %>% 
  group_by(TRE_CN) %>%
  do(plots=ggplot(data=.) +
       aes(x=Year, y=RW) + geom_point() + ggtitle(unique(.$TRE_CN)))

par(mfrow=c(2,2))
growth_yr_plots_es$plots[[1]]
growth_yr_plots_es$plots[[2]]
growth_yr_plots_es$plots[[3]]
growth_yr_plots_es$plots[[4]]
#can do more all the way to tree 26
```

```{r}
#understanding random effects: Year
growth_wateryr_plots_es <- glmm_es_z %>% 
  group_by(Year) %>%
  do(plots=ggplot(data=.) +
       aes(x=wateryr, y=RW) + geom_point() +
       geom_smooth(method = "lm") + ggtitle(unique(.$Year)))

par(mfrow=c(2,2))
growth_wateryr_plots_es$plots[[8]]
growth_wateryr_plots_es$plots[[15]]
growth_wateryr_plots_es$plots[[22]]
growth_wateryr_plots_es$plots[[29]]
#can all years 1962 - 1994
```

A proxy for age (time) is diameter at breast height, which is continuous. As a tree gets older, it grows, puts on biomass, and increases its diameter. While a tree could put on the same amount of biomass each year, the biomass will be stretched over an increasing larger circumference. As such, diameter increment decays as a tree ages, or as diameter at breast height increases. This age trend has been clearly described in tree-ring science. Below is a plot of age (dbh) by my response (incr), which is fit with a linear trend:

```{r}
par(mfrow=c(2,2))
#detrend
ggplot(data = glmm_es_z, aes(x = DIA_C, y = RW)) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

ggplot(data = glmm_es_z, aes(x = DIA_C, y = dds)) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

ggplot(data = glmm_es_z, aes(x = DIA_C, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

#log to reduce heteroscedasticity
ggplot(data = glmm_es_z, aes(x = log(DIA_C), y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
#positive relationship
```

Log transformation of DIA_C homogenizes variance and allows for linear relationship.

Site index is a measure of site quality. It is the estimated height in feet of a tree on the site at a specific age (FIA Database Description and User Guide for Phase 2).

```{r}
ggplot(data = glmm_es_z, aes(x = SICOND, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a postive relationship between growth and site index, meaning growth increases with increasing site quality. There is also relatively constant variance.

Slope is an estimated average at the subplot level, or condition level (FIA Database Description and User Guide for Phase 2).

```{r}
ggplot(data = glmm_es_z, aes(x = SLOPE, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is no relationship between growth and slope, and there is non-constant variance.

Basal area of trees larger than the subject tree (BAL) is a calculated covariate at the plot level.

```{r}
ggplot(data = glmm_es_z, aes(x = BAL, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and BAL, meaning growth decreases with increasing BAL. There is relatively constant variance.

Crown competition factor is a measure of stand density (Krajicek et al. 1961). Tree values of CCF estimate the percentage of an acre that would be covered by the tree’s crown if the tree were open grown (Dixon 2002). 

Crown competitition factor on the inventory point where the tree is established (PCCF) is a calculated covariate on the plot level.

```{r}
ggplot(data = glmm_es_z, aes(x = PCCF, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and PCCF, and there is relatively constant variance.

Stand crown competition factor (CCF) is a calculated covariate on the plot level. It is a summation of PCCF on the plot.

```{r}
ggplot(data = glmm_es_z, aes(x = CCF, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and CCF with relatively constant variance.

Crown ratio (CR/CR_fvs) is the percentage of the length of the tree with healthy foliage (FIA Database Description and User Guide for Phase 2). CR was extracted from the FIA Database for the measure year and copied backwards. CR_fvs was back calculated using the Weibull distribution (Dixon 1985) on a plot level.

```{r}
par(mfrow=c(1,2))
ggplot(data = glmm_es_z, aes(x = CR, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

ggplot(data = glmm_es_z, aes(x = CR_fvs, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a positive relationship between growth and CR and relatively constant variance. Likewise, there is a positive relationship between growth and CR_fvs and constant variance.

Based on the exploration, I will transform the response variable (dds) and DIA_C to linearize the relationship and reduce heterscedasticity and satisfy assumptions of normality of the response variable. I will also explore outliers with Cleveland dotplots. Normality and homogeneity will be further checked using the residuals of the final models.


## Model Building

```{r include=FALSE}
library(lme4)
library(lmerTest)
library(MuMIn)
#library(nlme)
#library(glmmTMB)
```

The current large-diameter growth model for the UT variant of FVS is a multiple regression.

* SICOND: species site index on a 50-year age basis
* ASPECT: stand aspect
* SLOPE: stand slop
* DIA_C: tree diameter at breast height
* BAL: total basal area in trees larger than the subject tree
* CR_fvs: tree's live crown ratio expressed as proportion
* PCCF: crown competition factor on the subplot level
* CCF: stand crown competition factor

All the covariates above are significant in the current model for Engelmann spruce, except SLOPE *^2*, DIA_C*^2*, and PCCF. In the model, the response variable (dds) and diameter at breast height (DIA_C) are log transformed to linearize the relationship. Basal area of larger trees than the subject tree (BAL) and CCF are divided by 100 to encourage model convergence. Below the structure for the current model is applied to annualized data set.

```{r eval=FALSE}
#current growth model with tree ring data (annual)
#slope^2, dia^2, pccf insignificant in current lm
lm_es <- lm(log(dds)~
           #tree variables
           I(log(DIA_C))+I(DIA_C^2)+
           CR_fvs+I(CR_fvs^2)+
           #climate
           #competition/density
           I(BAL/100)+PCCF+I(CCF/100)+
           #site variables
           SICOND+SLOPE+I(SLOPE^2)+
           I(sin(ASPECT-0.7854)*SLOPE)+
           I(cos(ASPECT-0.7854)*SLOPE),
              data = glmm_es_z)
```

Since there is a lot of unaccounted for variability due to individual tree and year differences, the updated model will be a mixed effects model. A random intercept on Tree ID and Year will be added to account for different baselines. A random slope on DIA_C for each year will serve as a detrending method to reduce the age effect in growth.

For now, I will use `lme4` to fit models. To fit a covariance-variance structure other than compound symmetry, I can use `nlme`. I may also explore the model fit options with `glmmTMB`.

Covariates are standardized, or mean-centered and divided by SD, to encourage model converage, which means there is no need for BAL and CCF to be divided by 100. In addition, the log transformation on DIA_C is problematic because a log of a negative number is impossible. Therefore, the log transformation on DIA_C will be removed.


# Annual Model of Tree Growth

In FVS, DBH*^2*, SLOPE*^2*, and PCCF not significant.

```{r warning=FALSE}
#add random effects
#random intercept for each tree
#random intercept for each year
#random slope on DBH for each tree (detrending method)
annual_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+#remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+#I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(annual_es)
```


## Model Selection

```{r warning=FALSE}
#add random effects
#random intercept for each tree
#random intercept for each year
#random slope on DBH for each tree (detrending method)
an_al_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_al_es)
```

### Collinearity

Using the full model with all the possile covariates, I will test for collinearity between predictors with the `car` package.

```{r echo=FALSE, warning=FALSE,message=FALSE}
library(car)
```

```{r}
vif(an_al_es)
```

A Variance Inflation Factor (VIF) above 3 shows strong collinearity. With VIF scores below 3, the model can be reduced based on significance or importance (i.e. coefficient value).

```{r}
summary(an_al_es)$coef
```

`CR_fvs`*^2* can be removed based on significance. 

```{r}
#reduce
#CR2
# Competition
an_bal_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_bal_es)
summary(an_bal_es)$coef
an_ccf_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_ccf_es)
summary(an_ccf_es)$coef
an_pccf_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_pccf_es)
summary(an_pccf_es)$coef
an_sdi_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_sdi_es)
summary(an_sdi_es)$coef
```

We could also try substituting `sin` and `cos`, the radiation parameters, for a single solar radiation parameter, such as the Swift's solar radiation potential (1976). Here, we use `solrad` package

```{r}
AIC(an_bal_es)
summary(an_bal_es)$coef
an_red_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red_es)
summary(an_red_es)$coef
an_smod_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_smod_es)
summary(an_smod_es)$coef
an_rmod_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_rmod_es)
summary(an_rmod_es)$coef
an_red_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                    control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red_es)
summary(an_red_es)$coef
an_red2_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                    control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red2_es)
summary(an_red2_es)$coef
```

```{r}
an_cr_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_cr_es)
summary(an_cr_es)$coef
an_red_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                    control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red_es)
summary(an_red_es)$coef
```


```{r}
an_red_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+#I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red_es)
summary(an_red_es)$coef
```


likelihood ratio test with FVS_LOC_CD

```{r}
AIC(an_red_es)
an_red2_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    #random effects
                    (1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red2_es)
anova(an_red_es,an_red2_es)
```


### Constant CR

```{r warning=FALSE}
#add random effects
#random intercept for each tree
#random intercept for each year
#random slope on DBH for each tree (detrending method)
an_al_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+I(z.CR^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_al_es)
vif(an_al_es)
summary(an_al_es)$coef
```

```{r}
#competition
an_bal_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_bal_es)
summary(an_bal_es)$coef
an_ccf_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_ccf_es)
summary(an_ccf_es)$coef
an_pccf_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_pccf_es)
summary(an_pccf_es)$coef
an_sdi_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_sdi_es)
summary(an_sdi_es)$coef
```

```{r}
AIC(an_bal_es)
an_red_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red_es)
summary(an_red_es)$coef
an_red2_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red2_es)
summary(an_red2_es)$coef
an_red3_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
AIC(an_red3_es)
summary(an_red3_es)$coef
```


# Annual Model with Climate

A tree's growth response is also influenced by climate, or temperature and precipitation, during the growing season. By annualizing the model with tree rings, climate can be included as a covariate. `ppt_` is the total precipitation over the following monthly range. `tmin/max_` is the average temperature over the following monthly range. Climate variables were chosen based on model AIC score, as well as ability to project into the future (e.g. `wateryr`).

```{r}
#add climate
#wateryear the best AIC
#can also try 16mon pJun-Sep
#tmax pAug and pJulSep best
clim_al_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+ 
                 z.CR_fvs+I(z.CR_fvs^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 #(1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_es_z)
AIC(clim_al_es)
```


## Model Selection

```{r}
clim_al_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_fvs+I(z.CR_fvs^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 #(1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_es_z)
AIC(clim_al_es)
```


### Collinearity

```{r}
vif(clim_al_es)
```

With VIF scores below 3, the model can be reduced based on significance or importance (i.e. coeficient value).

```{r}
summary(clim_al_es)$coef
```

`CR_fvs`*^2* can be removed based on significance. Also, it may not be necessary to include three competition factors: CR, CCF and BAL. We can reduce one based on model coefficients and significance.

```{r}
#reduce
#CR2
#competiton?
clim_bal_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_bal_es)
summary(clim_bal_es)$coef
clim_ccf_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_ccf_es)
summary(clim_ccf_es)$coef
clim_pcf_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.PCCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_pcf_es)
summary(clim_pcf_es)$coef
clim_sdi_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.SDI+ 
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_sdi_es)
summary(clim_sdi_es)$coef
```

We could also try substituting `sin` and `cos`, the radiation parameters, for a single solar radiation parameter, such as the Swift's solar radiation potential (1976).

```{r}
#radiation
clim_red_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+ 
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_red_es)
summary(clim_red_es)$coef
clim_red2_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+ 
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_red2_es)
summary(clim_red2_es)$coef
clim_red3_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+ 
                 #site variables
                 z.SICOND+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_red3_es)
summary(clim_red3_es)$coef
```


```{r}
clim_red_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+ 
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_red_es)
summary(clim_red_es)$coef
```

likelihood ratio test for FVS_LOC_CD

```{r}
AIC(clim_red_es)
clim_red2_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+ 
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 #random effects
                 (1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_red2_es)
anova(clim_red_es,clim_red2_es)
```

### Constant CR

```{r}
clim_al_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+I(z.CR^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_al_es)
vif(clim_al_es)
summary(clim_al_es)$coef
```

```{r}
#competition
clim_bal_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_bal_es)
summary(clim_bal_es)$coef
clim_ccf_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_ccf_es)
summary(clim_ccf_es)$coef
clim_pccf_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.PCCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_pccf_es)
summary(clim_pccf_es)$coef
clim_sdi_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.SDI+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_sdi_es)
summary(clim_sdi_es)$coef

```

```{r}
#solar radiation
clim_bal_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_bal_es)
summary(clim_bal_es)$coef
clim_mod_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_mod_es)
summary(clim_mod_es)$coef
clim_red_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_red_es)
summary(clim_red_es)$coef
clim_red2_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_red2_es)
summary(clim_red2_es)$coef
```


## Model Diagnostics

```{r}
#tree ring model
an_al_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.CCF+#z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+#I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
an_red_es <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+ #reduces AIC by 4
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = glmm_es_z)
#tr + climate model
clim_al_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR_fvs+I(z.CR_fvs^2)+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+z.CCF+#z.PCCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+#I(z.SLOPE^2)+
                 z.sin+z.cos+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
               data = glmm_es_z)
clim_red_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 #z.CR_fvs+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+ 
                 #site variables
                 z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
```

### Test of Normality

The linear mixed effect model assumes a Gaussian (normal) distribution. To test that assumption, a quantile-quantile (qq) plot will plot our distribution against a normal distribution.

```{r echo=FALSE}
#residuals
par(mfrow=c(2,2))

#full annual
resid_annual<- residuals(annual_es,type="pearson",scaled=TRUE)
qqnorm(resid_annual,main="QQ plot of Full Annual")
qqline(resid_annual)
hist(resid_annual, breaks = 50, main = "Histogram of Full Annual Residuals")

#annual reduced
resid_annred <- residuals(an_red_es,type="pearson",scaled=TRUE)
qqnorm(resid_annred,main="QQ plot of Reduced Annual")
qqline(resid_annred)
hist(resid_annred, breaks = 50, main = "Histogram of Reduced Annual Residuals")

#clim_16
resid_clm<- residuals(clim_al_es,type="pearson",scaled=TRUE)
qqnorm(resid_clm,main="QQ plot of Full Climate")
qqline(resid_clm)
hist(resid_clm, breaks = 50, main = "Histogram of Full Climate Residuals")

#clim_red_es
resid_clmred <- residuals(clim_red_es,type="pearson",scaled=TRUE)
qqnorm(resid_clmred,main="QQ plot of Reduced Climate")
qqline(resid_clmred)
hist(resid_clmred, breaks = 50, main = "Histogram of Reduced Climate Residuals")
```

### Test of Homoscedasticity

```{r include=FALSE}
library(gplots)
```

To test if my transformed residuals have a constant variance with a mean of zero, I will plot transformed residuals vs predicted values.

```{r}
par(mfrow=c(2,2))
pred_annual <- predict(annual_es, type="response")
plotLowess(resid_annual~pred_annual, ylab="Residuals",xlab="Predicted", main="Full Annual")
pred_annred <- predict(an_red_es, type="response")
plotLowess(resid_annred~pred_annred, ylab="Residuals",xlab="Predicted", main="Reduced Annual")
pred_clm <- predict(clim_al_es, type="response")
plotLowess(resid_clm~pred_clm, ylab="Residuals",xlab="Predicted", main="Full Climate")
pred_clmred <- predict(clim_red_es, type="response")
plotLowess(resid_clmred~pred_clmred, ylab="Residuals",xlab="Predicted", main="Reduced Climate")
```

We can also test if residuals have a constant variance against predictor variables. Below plots are only given for the reduced climate model, but more models can be plotted.

```{r echo=FALSE}
par(mfrow=c(2,2))
#dbh
plotLowess(resid_clmred~z.DIA_C,data = glmm_es_z,ylab="Residuals",main="Climate Reduced: DBH")
#plotLowess(resid_lmm1~z.DIA_C,data = glmm_es_z,ylab="Residuals",main="LMM1")
#CR
plotLowess(resid_clmred~z.CR_fvs,data = glmm_es_z,ylab="Residuals",main="Climate Reduced: CR")
#plotLowess(resid_lmm1~z.CR_fvs,data = glmm_es_z,ylab="Residuals",main="LMM1")
#precip
plotLowess(resid_clmred~z.ppt_pJunAug,data = glmm_es_z,ylab="Residuals",main="Climate Reduced: Precip") 
#plotLowess(resid_lmm1~z.ppt_pJunAug,data = glmm_es_z,ylab="Residuals",main="LMM1") 
#temp
plotLowess(resid_clmred~z.tmax_pAug,data = glmm_es_z,ylab="Residuals",main="Climate Reduced: Temp")
#plotLowess(resid_lmm1~z.tmax_pAug,data = glmm_es_z,ylab="Residuals",main="LMM1")
#CCF
plotLowess(resid_clmred~z.BAL,data = glmm_es_z,ylab="Residuals",main="Climate Reduced: CCF")
#plotLowess(resid_lmm1~z.CCF,data = glmm_es_z,ylab="Residuals",main="LMM1")
#SI
plotLowess(resid_clmred~z.SICOND,data = glmm_es_z,ylab="Residuals",main="Climate Reduced: SI")
#plotLowess(resid_lmm1~z.SICOND,data = glmm_es_z,ylab="Residuals",main="LMM1")
#Slope
plotLowess(resid_clmred~z.SLOPE,data = glmm_es_z,ylab="Residuals",main="Climate Reduced: Slope")
#plotLowess(resid_lmm1~z.SLOPE,data = glmm_es_z,ylab="Residuals",main="LMM1")
```


### Mining

```{r}
#reduced models
#BALIVE


```


## Visualization

```{r include=FALSE}
library(broom.mixed)
library(dotwhisker)
```

```{r echo=FALSE, message=FALSE,warning=FALSE}

full_an_es <-  tidy(annual_es) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "FVS Annual")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "Crown Ratio",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_pAug = "Temperature",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2",
                       z.sin = "sin(Aspect-0.7854)*Slope",
                       z.cos = "cos(Aspect-0.7854)*Slope"))
red_an_es <-  tidy(an_red_es) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Reduced Annual")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_pAug = "Temperature",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2",
                       z.sin = "sin(Aspect-0.7854)*Slope",
                       z.cos = "cos(Aspect-0.7854)*Slope",
                       z.solrad_MayAug = "solrad"))
full_clim_es <-  tidy(clim_al_es) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "FVS Climate")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "Crown Ratio",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_pAug = "Temperature",
                       "z.ppt_pJunSep:z.tmax_pAug" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2",
                       z.sin = "sin(Aspect-0.7854)*Slope",
                       z.cos = "cos(Aspect-0.7854)*Slope"))

red_clim_es <-  tidy(clim_red_es) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Reduced Climate")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "Crown Ratio",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_pAug = "Temperature",
                       "z.ppt_pJunSep:z.tmax_pAug" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2",
                       z.sin = "sin(Aspect-0.7854)*Slope",
                       z.cos = "cos(Aspect-0.7854)*Slope"))
models_es <- full_join(full_an_es,red_an_es) %>%
  full_join(.,full_clim_es) %>%
  full_join(.,red_clim_es)
mod_es <- dwplot(models_es, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
       # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  ggtitle("Growth for Engelmann spruce") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
mod_es
```

```{r}
full_mod_es <- full_join(full_an_es,full_clim_es)
dwplot(full_mod_es, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
       # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  ggtitle("Growth for Engelmann spruce") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
red_mod_es <- full_join(red_an_es,red_clim_es)
dwplot(red_mod_es, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
       # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  ggtitle("Growth for Engelmann spruce") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
```


## Interpretation

We can start to understand the influence of the covariate on the response variable, tree growth, with the `effects` package. Keeping all other variables constant, it shows the effect of the covariate on the reponse.

```{r include=FALSE}
library(effects)
```

### Diameter at Breast Height

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.DIA_C",annual_es),xlab = "DBH",main = "Full Annual")
plot(effect("z.DIA_C",an_red_es),xlab = "DBH",main = "Reduced Annual")
plot(effect("z.DIA_C",clim_al_es),xlab = "DBH",main = "Full Climate")
plot(effect("z.DIA_C",clim_red_es),xlab = "DBH",main = "Reduced Climate")
```

### Crown Ratio

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.CR_fvs",annual_es),xlab = "Crown Ratio",main = "Full Annual")
plot(effect("z.CR_fvs",an_red_es),xlab = "Crown Ratio",main = "Reduced Annual")
plot(effect("z.CR_fvs",clim_al_es),xlab = "Crown Ratio",main = "Full Climate")
plot(effect("z.CR_fvs",clim_red_es),xlab = "Crown Ratio",main = "Reduced Climate")
```

### Basal area of tress larger than the subject

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.BAL",annual_es),xlab = "BAL",main = "Full Annual")
plot(effect("z.BAL",an_red_es),xlab = "BAL",main = "Reduced Annual")
plot(effect("z.BAL",clim_al_es),xlab = "BAL",main = "Full Climate")
plot(effect("z.BAL",clim_red_es),xlab = "BAL",main = "Reduced Climate")
```

### Site Index

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.SICOND",annual_es),xlab = "Site Index",main = "Full Annual")
plot(effect("z.SICOND",an_red_es),xlab = "Site Index",main = "Reduced Annual")
plot(effect("z.SICOND",clim_al_es),xlab = "Site Index",main = "Full Climate")
plot(effect("z.SICOND",clim_red_es),xlab = "Site Index",main = "Reduced Climate")
```

### Slope

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.SLOPE",annual_es),xlab = "Slope",main = "Full Annual")
plot(effect("z.SLOPE",an_red_es),xlab = "Slope",main = "Reduced Annual")
plot(effect("z.SLOPE",clim_al_es),xlab = "Slope",main = "Full Climate")
plot(effect("z.SLOPE",clim_red_es),xlab = "Slope",main = "Reduced Climate")
```

### Radiation

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.sin",annual_es),xlab = "sin(Aspect-0.7854)*Slope",main = "Full Annual")
plot(effect("z.sin",an_red_es),xlab = "sin(Aspect-0.7854)*Slope",main = "Reduced Annual")
plot(effect("z.sin",clim_al_es),xlab = "sin(Aspect-0.7854)*Slope",main = "Full Climate")
plot(effect("z.sin",clim_red_es),xlab = "sin(Aspect-0.7854)*Slope",main = "Reduced Climate")
```

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.cos",annual_es),xlab = "cos(Aspect-0.7854)*Slope",main = "Full Annual")
plot(effect("z.cos",an_red_es),xlab = "cos(Aspect-0.7854)*Slope",main = "Reduced Annual")
plot(effect("z.cos",clim_al_es),xlab = "cos(Aspect-0.7854)*Slope",main = "Full Climate")
plot(effect("z.cos",clim_red_es),xlab = "cos(Aspect-0.7854)*Slope",main = "Reduced Climate")
```

### Climate

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(1,2))
plot(effect("z.ppt_pJunSep",clim_al_es),xlab = "Precipitation",main = "Full Climate")
plot(effect("z.ppt_pJunSep",clim_red_es),xlab = "Precipitation",main = "Reduced Climate")
plot(effect("z.tmax_pAug",clim_al_es),xlab = "Temperature",main = "Full Climate")
plot(effect("z.tmax_pAug",clim_red_es),xlab = "Temperature",main = "Reduced Climate")
```
```{r echo=FALSE}
plot(effect("z.ppt_pJunSep:z.tmax_pAug",clim_al_es),xlab = "Interaction",main = "Full Climate")
plot(effect("z.ppt_pJunSep:z.tmax_pAug",clim_red_es),xlab = "Interaction",main = "Reduced Climate")
```

