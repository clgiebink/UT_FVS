---
title: "Linear Mixed Model for Ponderosa Pine"
author: "Courtney Giebink"
date: "August 6, 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
```

## Data Summary

```{r include=FALSE}
load(file = '/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/varmt_pp_z.Rdata')
```

My data comes from the U. S. Forest Service's Interior West - Forest Inventory and Analysis (IW-FIA) program (DeRose, Shaw, and Long 2017). The U.S. Forest Service’s Forest Inventory and Analysis program has established plots across the nation, which they use to collect data on forest stands. Recently, tree rings associated with plots in the Interior West states were discovered in storage. The IW-FIA program merged these two data sources: inventory data and tree-ring data. The data that I will use for my analysis is inventory and tree-ring data for *Pinus ponderosa* (Ponderosa pine) in Utah. 

```{r echo=FALSE, message=FALSE}
library(maps)
m = map_data('state', region = 'Utah')

ggplot() + 
  geom_polygon( data=m, aes(x=long, y=lat,group=group),colour="black", fill="white" )+
  geom_point(data=varmt_pp_z,aes(x=LON,y=LAT),colour="red")+
  ggtitle("Distribution of ponderosa pine")+
  xlab('Longitude')+
  ylab('Latitude')+
  coord_fixed()
```


I was able to extract and calculate annual data for 51 trees between the years of 1962 and 1995. 

```{r eval=FALSE}
#create new dataframe with only variables needed for model
#response: RW, dds
#fixed: SI, ASP, SL, DBH/DIA_C, BAL, CR, CCF, PCCF, climate
#random: TRE_CN, Year
#filter for last 30 years of growth
min(data_all_pp$MEASYEAR) #1992 -> 1962

glmm_data_pp <- data_all_pp %>%
  dplyr::select(PLT_CN,TRE_CN, RW, dds, Year, DIA_C, 
         SICOND, ASPECT, tASPECT, SLOPE, BAL, CR, CR_fvs, PCCF, CCF, cos, sin,
         ppt_pDec, ppt_Jun, ppt_Jul, ppt_pOct,
         ppt_pAugOct, ppt_pOctDec, ppt_pNovJan, ppt_MayJul,
         ppt_pAugJan, wateryr, ppt_pAugJul, ppt_pJunSep,
         tmax_Jun, tmax_JunAug) %>%
  filter(Year >= 1962)

#climate
#total ppt
#1 month: ,pDec, Jun, Jul, pOct
#3 month: pAug-pOct, pOct-pDec, pNov-Jan, May-Jul
#6 month + : Jan, wateryr

#average temp
#1 month: Jun tmax
#3 month: tmax_Jun-Aug
```

My data, `glmm_data_pp`, consists of raw radial increment, or ring width value, (`RW`) in mm and annual change in squared inside bark diameter (dds) in inches^2 with corresponding tree, climate, and site variables. Some variables stay constant, such as site index (`SICOND`), aspect (`ASPECT`), and slope (`SLOPE`), while diameter at breast height (`DIA_C`) and crown ratio (CR, CR_fvs) vary annually. In addition, density variables, being basal area of trees larger than the subject tree (`BAL`), crown competition factor on the inventory point (`PCCF`), and stand crown competition factor (`CCF`), vary annually. Significant seasonal precipitation and temperature variables were identified based on tradition dendro analysis tools, using R packages `dplR` and `treeclim` (see `Climate-growth.Rmd`)


## Exploration

It is necessary to explore the dataset to determine if the data complies with model assumptions (Zuur, Ieno, and Elphick 2010).

### Normality

The response variable, annual change in squared inside bark diameter (DDS), is continuous. It will be explained using a linear mixed model.

```{r}
par(mfrow=c(2,2))
hist(varmt_pp_z$RW,breaks = 50, 
     main = "Histogram of RW (mm)", xlab = "Increment")
hist(varmt_pp_z$dds,breaks = 100,
     main = "Histogram of DDS (in^2)", xlab = "Increment")
hist(log(varmt_pp_z$dds),breaks = 100, 
     main = "Histogram of log(DDS)", xlab = "Increment")
```

The distribution of DDS is highly skewed right, whereas the distribution of raw radial increment (RW) is slightly skewed right. The Gamma distribution is often used for skewed data, although Gaussian might still be appropriate and easier to interpret. 

```{r}
#Cleveland dotplot
par(mfrow=c(1,2))
dotchart(varmt_pp_z$dds)
dotchart(log(varmt_pp_z$dds))
```

A log transformation of dds skews the distribution to the left.

There is one consistent larger value at just over 6 mm.

### Zeros and Missing Data

```{r}
which(varmt_pp_z$RW == 0) #missing data
which(is.na(varmt_pp_z$RW))
which(varmt_pp_z$dds ==0)

range_df <- varmt_pp_z %>%
  select(TRE_CN,Year) %>%
  group_by(TRE_CN) %>%
  summarise(minyr = min(Year),
            maxyr = max(Year))%>%
  gather("stat","year",-TRE_CN)
ggplot(range_df, aes(year, as.character(TRE_CN))) +
        geom_point(aes(color = stat)) +
   theme(axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  ylab("TRE_CN")
```

My data is unbalanced. Most trees have a growth measurement for 1962, but the last year of growth is not the same for all trees. Most trees end growth in 1994, but some end in 1992, 1993, or 1995. There are no missing data in between first and last year of growth for each tree, and there are no years of zero growth, indicating a missing ring.

### Random and Fixed Effects

In the linear mixed effects model, tree, stand, and climate variables will be fixed effects and a tree identifier and year of growth will be random effects.

```{r}
length(unique(varmt_pp_z$TRE_CN))
length(unique(varmt_pp_z$PLT_CN))
```

There are almost as many unique plots as unique trees, so it is not necessary to have plots as a random effect as well.

Tree ID and year are appropriate random effects because selected trees and years are a subset from all the possible selected trees and years (Harrison et al. 2018). Each tree has its own intercept of growth due to factors not considered here, such as genetics, microclimate, etc. Each year has its own intercept of growth due to relatively good or poor conditions not accounted for in temperature and precipitation, such as cloud cover, vapor pressure deficit, etc. Each tree and year might also have its own slope, but convergence on a random slope effect can only occur with an adequate amount of data.

```{r warning=FALSE}
#understanding random effects: TRE_CN
growth_yr_plots_pp <- varmt_pp_z %>% 
  group_by(TRE_CN) %>%
  do(plots=ggplot(data=.) +
       aes(x=Year, y=RW) + geom_point() + ggtitle(unique(.$TRE_CN)))

par(mfrow=c(2,2))
growth_yr_plots_pp$plots[[1]]
growth_yr_plots_pp$plots[[2]]
growth_yr_plots_pp$plots[[3]]
growth_yr_plots_pp$plots[[4]]
#can do more all the way to tree 51
```

```{r warning=FALSE}
#understanding random effects: Year
growth_wateryr_plots_pp <- varmt_pp_z %>% 
  group_by(Year) %>%
  do(plots=ggplot(data=.) +
       aes(x=wateryr, y=RW) + geom_point() +
       geom_smooth(method = "lm") + ggtitle(unique(.$Year)))

par(mfrow=c(2,2))
growth_wateryr_plots_pp$plots[[8]]
growth_wateryr_plots_pp$plots[[15]]
growth_wateryr_plots_pp$plots[[22]]
growth_wateryr_plots_pp$plots[[29]]
#can all years 1962 - 1995
```

A proxy for age (time) is diameter at breast height, which is continuous. As a tree gets older, it grows, puts on biomass, and increases its diameter. While a tree could put on the same amount of biomass each year, the biomass will be stretched over an increasing larger circumference. As such, diameter increment decays as a tree ages, or as diameter at breast height increases. This age trend has been clearly described in tree-ring science. Below is a plot of age (dbh) by my response (incr), which is fit with a linear trend:

```{r}
par(mfrow=c(2,2))
#detrend
ggplot(data = varmt_pp_z, aes(x = DIA_C, y = RW)) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

ggplot(data = varmt_pp_z, aes(x = DIA_C, y = dds)) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
#variance relatively constant

ggplot(data = varmt_pp_z, aes(x = DIA_C, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")

#log to reduce heteroscedasticity
ggplot(data = varmt_pp_z, aes(x = log(DIA_C), y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
#log makes it worse
#negative relationship
```

Site index is a measure of site quality. It is the estimated height in feet of a tree on the site at a specific age (FIA Database Description and User Guide for Phase 2).

```{r}
ggplot(data = varmt_pp_z, aes(x = SICOND, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a slight postive relationship between growth and site index, meaning growth increases with increasing site quality. There is also relatively constant variance.

Slope is an estimated average at the subplot level, or condition level (FIA Database Description and User Guide for Phase 2).

```{r}
ggplot(data = varmt_pp_z, aes(x = SLOPE, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and slope, meaning growth decreases with increasing slope. There is also relatively constant variance.

Basal area of trees larger than the subject tree (BAL) is a calculated covariate at the plot level.

```{r warning=FALSE}
ggplot(data = varmt_pp_z, aes(x = BAL, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and BAL, and there is relatively constant variance.

Crown competition factor is a measure of stand density (Krajicek et al. 1961). Tree values of CCF estimate the percentage of an acre that would be covered by the tree’s crown if the tree were open grown (Dixon 2002). 

Crown competitition factor on the inventory point where the tree is established (PCCF) is a calculated covariate on the plot level.

```{r}
ggplot(data = varmt_pp_z, aes(x = PCCF, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and PCCF, and there is relatively constant variance.

Stand crown competition factor (CCF) is a calculated covariate on the plot level. It is a summation of PCCF on the plot.

```{r}
ggplot(data = varmt_pp_z, aes(x = CCF, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a negative relationship between growth and CCF. In addition, there is most likely an outlier in the dataset.

Crown ratio (CR/CR_fvs) is the percentage of the length of the tree with healthy foliage (FIA Database Description and User Guide for Phase 2). CR was extracted from the FIA Database for the measure year and copied backwards. CR_fvs was back calculated using the Weibull distribution (Dixon 1985) on a plot level.

```{r}
par(mfrow=c(1,2))
ggplot(data = varmt_pp_z, aes(x = CR, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
ggplot(data = varmt_pp_z, aes(x = CR_fvs, y = log(dds))) +
  geom_point(alpha=0.1) + geom_smooth(method = "lm")
```

There is a positive relationship between growth and CR and relatively constant variance. However, there is a slight negative relationship between growth and CR_fvs and non-constant variance.

Based on the exploration, I will transform the response variable (dds) to satisfy assumptions of normality of the response variable. I will also further explore outliers with Cleveland dotplots. Normality and homogeneity will be further checked using the residuals of the final models.


## Model Building

```{r include=FALSE}
library(lme4)
library(lmerTest)
library(MuMIn)
#library(nlme)
#library(glmmTMB)
```

The current large-diameter growth model for the UT variant of FVS is a multiple regression.

* SICOND: species site index on a 50-year age basis
* ASPECT: stand aspect
* SLOPE: stand slop
* DIA_C: tree diameter at breast height
* BAL: total basal area in trees larger than the subject tree
* CR_fvs: tree's live crown ratio expressed as proportion
* PCCF: crown competition factor on the subplot level
* CCF: stand crown competition factor

All the covariates above are significant in the current model for ponderosa pine, except crown competition factor (CCF). In the model, the response variable (dds) and diameter at breast height (DIA_C) are log transformed to linearize the relationship. Basal area of larger trees than the subject tree (BAL) and CCF are divided by 100 to encourage model convergence. Below the structure for the current model is applied to annualized data set.

```{r eval=FALSE}
#current growth model with tree ring data (annual)
#ccf insignificant in current lm
lm_pp <- lm(log(dds)~
           #tree variables
           I(log(DIA_C))+I(DIA_C^2)+
           CR_fvs+I(CR_fvs^2)+
           #climate
           #competition/density
           I(BAL/100)+PCCF+I(CCF/100)+
           #site variables
           SICOND+SLOPE+I(SLOPE^2)+
           I(sin(ASPECT-0.7854)*SLOPE)+
           I(cos(ASPECT-0.7854)*SLOPE),
              data = varmt_pp_z)
```

Since there is a lot of unaccounted for variability due to individual tree and year differences, the updated model will be a mixed effects model. A random intercept on Tree ID and Year will be added to account for different baselines. A random slope on DIA_C for each year will serve as a detrending method to reduce the age effect in growth.

For now, I will use `lme4` to fit models. To fit a covariance-variance structure other than compound symmetry, I can use `nlme`. I may also explore the model fit options with `glmmTMB`.

Covariates are standardized, or mean-centered and divided by SD, to encourage model converage, which means there is no need for BAL and CCF to be divided by 100. In addition, the log transformation on DIA_C is problematic because a log of a negative number is impossible. Therefore, the log transformation on DIA_C will be removed.

# Random Effects

```{r}
tre_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    #(1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                    (1|TRE_CN),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
tyre_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    #(1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                    (1|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
tsyre_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    #(1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
anova(tre_pp,tyre_pp,tsyre_pp)
```


# Annual Model of Tree Growth

In FVS, CCF is not significant.

```{r}
#add random effects
#random intercept for each tree
#random intercept for each year
#random slope on DBH for each tree (detrending method)
annual_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    #(1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(annual_pp)
```

## Model Selection


```{r}
an_al_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.CCF+z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_al_pp)
```

### Collinearity

Using the full model with all the possile covariates, I will test for collinearity between predictors with the `car` package.

```{r echo=FALSE, warning=FALSE,message=FALSE}
library(car)
```

```{r}
vif(an_al_pp)
```

A Variance Inflation Factor (VIF) above 3 shows strong collinearity. Slope and slope squared seem to be mildly correlated. With VIF scores below 3, the model can be reduced based on significance or importance (coefficient value).

```{r}
summary(an_al_pp)$coef
```

`SLOPE`*^2* can be removed based on significance.

```{r}
#reduce
#Slope^2
#competition?
an_bal_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_bal_pp)
summary(an_bal_pp)$coef
an_ccf_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_ccf_pp)
summary(an_ccf_pp)$coef
an_pccf_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_pccf_pp)
summary(an_pccf_pp)$coef
an_sdi_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                  control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_sdi_pp)
summary(an_sdi_pp)$coef
```

We could also try substituting `sin` and `cos`, the radiation parameters, for a single solar radiation parameter, such as the Swift's solar radiation potential (1976).

```{r}
#AIC(an_bal_pp)
#summary(an_bal_pp)$coef
an_red_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_red_pp)
summary(an_red_pp)$coef
an_red2_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_red2_pp)
summary(an_red2_pp)$coef
an_red3_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_red3_pp)
summary(an_red3_pp)$coef
an_smod_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_smod_pp)
summary(an_smod_pp)$coef
an_rmod_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_rmod_pp)
summary(an_rmod_pp)$coef
```


```{r}
an_red_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
summary(an_red_pp)$coef
```

likelihood ratio test

```{r}
AIC(an_red_pp)
an_red2_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|FVS_LOC_CD/TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_red2_pp)
anova(an_red_pp,an_red2_pp)
```

### Constant CR

```{r}
an_al_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+I(z.CR^2)+
                    #climate
                    #competition/density
                    z.BAL+z.CCF+z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_al_pp)
vif(an_al_pp)
summary(an_al_pp)$coef
```

```{r}
#reduce
#cr^2 and slope^2
#test competition
an_cr_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR+
                    #climate
                    #competition/density
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_cr_pp)
summary(an_cr_pp)$coef
an_bal_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR+
                    #climate
                    #competition/density
                    z.BAL+#z.CCF+z.PCCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_bal_pp)
summary(an_bal_pp)$coef
an_ccf_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR+
                    #climate
                    #competition/density
                    z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_ccf_pp)
summary(an_ccf_pp)$coef
an_sdi_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #z.CR+
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_sdi_pp)
summary(an_sdi_pp)$coef
```

```{r}
AIC(an_sdi_pp)
summary(an_sdi_pp)$coef
an_mod_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    z.solrad_MayAug+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_mod_pp)
summary(an_mod_pp)$coef
an_red_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #climate
                    #competition/density
                    z.SDI+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
AIC(an_red_pp)
summary(an_red_pp)$coef
```


# Annual Model with Climate

A tree's growth response is also influenced by climate, or temperature and precipitation, during the growing season. By annualizing the model with tree rings, climate can be included as a covariate. `ppt_` is the total precipitation over the following monthly range. `tmin/max_` is the average temperature over the following monthly range. Climate variables were chosen based on model AIC score, as well as ability to project into the future (e.g. `wateryr`).

```{r}
#add climate
#for pp, previous Oct is the most correlated
#with pAug-Oct giving the best AIC
#however a specific seasonal range of precipitation might be hard to predict
#use 16mon pJun-Sep
#better AIC than wateryear
clim_16_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.CR_fvs+I(z.CR_fvs^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+z.PCCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                     z.sin+z.cos+
                     #random effects
                     #(1|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_16_pp)
```


## Model Selection

```{r}
clim_al_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.CR_fvs+I(z.CR_fvs^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_al_pp)
```


### Collinearity

```{r}
vif(clim_al_pp)
```

With VIF scores below 3, the model can be reduced based on significance or importance (i.e. coeficient value).

```{r}
summary(clim_al_pp)$coef
```

`SLOPE`*^2* can be removed based on significance.

```{r}
#reduce
#SLOPE2
#competition
clim_bal_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR_fvs+I(z.CR_fvs^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+#z.SLOPE+
                     #random effect
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_bal_pp)
summary(clim_bal_pp)$coef
clim_bal_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR_fvs+I(z.CR_fvs^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     #z.SICOND+#z.SLOPE+
                     #random effect
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_bal_pp)
summary(clim_bal_pp)$coef
clim_ccf_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR_fvs+I(z.CR_fvs^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+#z.SLOPE+
                     #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_ccf_pp)
summary(clim_ccf_pp)$coef
clim_pccf_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR_fvs+I(z.CR_fvs^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+
                     #competition/density
                     z.PCCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+#z.SLOPE+
                     #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_pccf_pp)
summary(clim_pccf_pp)$coef
clim_sdi_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR_fvs+I(z.CR_fvs^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+
                     #competition/density
                     z.SDI+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+#z.SLOPE+
                     #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_sdi_pp)
summary(clim_sdi_pp)$coef
```

We could also try substituting `sin` and `cos`, the radiation parameters, for a single solar radiation parameter, such as the Swift's solar radiation potential (1976).

```{r}
clim_red_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.sin+z.cos+
                     #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_red_pp)
summary(clim_red_pp)$coef
clim_red_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_red_pp)
summary(clim_red_pp)$coef
clim_red3_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_red3_pp)
summary(clim_red3_pp)$coef
clim_smod_pp <- lmer(log(dds)~
                       #tree variables
                       z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                       #climate
                       z.ppt_pJunSep*z.tmax_JunAug+
                       #competition/density
                       z.BAL+ #remove /100 due to standardization
                       #site variables
                       z.SICOND+z.SLOPE+
                       z.solrad_MayAug+
                       #random effects
                       (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                     data = varmt_pp_z)
AIC(clim_smod_pp)
summary(clim_smod_pp)$coef
clim_rmod_pp <- lmer(log(dds)~
                       #tree variables
                       z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                       #climate
                       z.ppt_pJunSep*z.tmax_JunAug+
                       #competition/density
                       z.BAL+ #remove /100 due to standardization
                       #site variables
                       z.SICOND+
                       z.solrad_MayAug+
                       #random effects
                       (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                     data = varmt_pp_z)
AIC(clim_rmod_pp)
summary(clim_rmod_pp)$coef
clim_rmod_pp <- lmer(log(dds)~
                       #tree variables
                       z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                       #climate
                       z.ppt_pJunSep*z.tmax_JunAug+
                       #competition/density
                       z.BAL+ #remove /100 due to standardization
                       #site variables
                       #random effects
                       (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                     data = varmt_pp_z)
AIC(clim_rmod_pp)
summary(clim_rmod_pp)$coef
```

```{r}
clim_red_pp <- lmer(log(dds)~
                       #tree variables
                       z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                       z.CR_fvs+#I(z.CR_fvs^2)+
                       #climate
                       z.ppt_pJunSep*z.tmax_JunAug+
                       #competition/density
                       z.BAL +#z.CCF+ #remove /100 due to standardization
                       #site variables
                       z.SICOND+
                       #random effects
                       (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                     data = varmt_pp_z)
summary(clim_red_pp)$coef
```


likelihood ratio test for FVS_LOC_CD

```{r}
AIC(clim_red_pp)
clim_red2_pp <- lmer(log(dds)~
                       #tree variables
                       z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                       z.CR_fvs+I(z.CR_fvs^2)+
                       #climate
                       z.ppt_pJunSep*z.tmax_JunAug+
                       #competition/density
                       z.CCF+ #remove /100 due to standardization
                       #site variables
                       z.SICOND+
                       #random effects
                       (1+z.DIA_C|FVS_LOC_CD/TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                     data = varmt_pp_z)
AIC(clim_red2_pp)
anova(clim_red_pp,clim_red2_pp)
```

### Constant CR

```{r}
clim_al_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.CR+I(z.CR^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+z.PCCF+z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_al_pp)
vif(clim_al_pp)
summary(clim_al_pp)$coef
```

```{r}
clim_bal_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_bal_pp)
summary(clim_bal_pp)$coef
clim_ccf_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_ccf_pp)
summary(clim_ccf_pp)$coef
clim_pccf_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.PCCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_pccf_pp)
summary(clim_pccf_pp)$coef
clim_sdi_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.SDI+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_sdi_pp)
summary(clim_sdi_pp)$coef
```

```{r}
clim_cbl_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_cbl_pp)
summary(clim_cbl_pp)$coef
clim_bal_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_bal_pp)
summary(clim_bal_pp)$coef
clim_ccf_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_ccf_pp)
summary(clim_ccf_pp)$coef
clim_sdi_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.SDI+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_sdi_pp)
summary(clim_sdi_pp)$coef
```

```{r}

clim_red_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_red_pp)
summary(clim_red_pp)$coef
clim_red2_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_red2_pp)
summary(clim_red2_pp)$coef
clim_mod_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     z.solrad_MayAug+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_mod_pp)
clim_rmod_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     z.solrad_MayAug+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_rmod_pp)
summary(clim_rmod_pp)$coef
```

### Normals

```{r}
clim_n_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.DIA_C:z.BAL+
                     #climate
                     z.ppt_pJunSep+z.tmax_JunAug+#interaction significant
                     #z.n_ppt+z.n_tmp+
                     z.n_ppt:z.ppt_pJunSep+
                     z.n_tmp:z.ppt_pJunSep+
                     #z.n_ppt:z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_n_pp)
summary(clim_n_pp)$coef
```

```{r}
plot_model(clim_n_pp, type = "pred", terms = c("z.ppt_pJunSep","z.n_ppt"),
                    axis.title = c("Precip","dds"), legend.title = "Precip Normal", title = "")
plot_model(clim_n_pp, type = "pred", terms = c("z.ppt_pJunSep","z.n_tmp"),
                    axis.title = c("Precip","dds"), legend.title = "Temp Normal", title = "")
plot_model(clim_n_pp, type = "pred", terms = c("z.tmax_JunAug","z.n_ppt"),
                    axis.title = c("Temp","dds"), legend.title = "Precip Normal", title = "")
```


```{r}
clim_int_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.DIA_C:z.BAL+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_int_pp)
summary(clim_int_pp)$coef
plot_model(clim_int_pp, type = "pred", terms = c("z.BAL","z.DIA_C"), title = "")
```



```{r}
clim_nint_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.DIA_C:z.BAL+
                     #climate
                     z.ppt_pJunSep+z.tmax_JunAug+#interaction significant
                     #z.n_ppt+z.n_tmp+
                     z.n_ppt:z.ppt_pJunSep+
                     z.n_tmp:z.ppt_pJunSep+
                     z.n_ppt:z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     z.BAL:z.n_ppt+
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_nint_pp)
summary(clim_nint_pp)$coef
clim_nint_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.DIA_C:z.BAL+
                     #climate
                     z.ppt_pJunSep+z.tmax_JunAug+#interaction significant
                     #z.n_ppt+z.n_tmp+
                     z.n_ppt:z.ppt_pJunSep+
                     z.n_tmp:z.ppt_pJunSep+
                     z.n_ppt:z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     z.BAL:z.n_tmp+
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_nint_pp)
summary(clim_nint_pp)$coef
clim_nint_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.DIA_C:z.BAL+
                     #climate
                     z.ppt_pJunSep+z.tmax_JunAug+#interaction significant
                     #z.n_ppt+z.n_tmp+
                     z.n_ppt:z.ppt_pJunSep+
                     z.n_tmp:z.ppt_pJunSep+
                     z.n_ppt:z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_nint_pp)
summary(clim_nint_pp)$coef
clim_nint_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.DIA_C:z.BAL+
                     #climate
                     z.ppt_pJunSep+z.tmax_JunAug+#interaction significant
                     #z.n_ppt+z.n_tmp+
                     z.n_ppt:z.ppt_pJunSep+
                     z.n_tmp:z.ppt_pJunSep+
                     z.n_ppt:z.tmax_JunAug+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     z.BAL:z.n_ppt+
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(clim_nint_pp)
summary(clim_nint_pp)$coef
```



### Random effects

```{r}
clim_mod_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     #random effects
                    (1+z.DIA_C|FVS_LOC_CD/TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
anova(clim_red_pp,clim_mod_pp)
#FVSLOCCD
n_tre_floc <- varmt_pp_z %>%
  ungroup() %>%
  dplyr::select(TRE_CN,FVS_LOC_CD) %>%
  distinct() %>%
  group_by(FVS_LOC_CD) %>%
  summarize(n_tre = length(unique(TRE_CN)))
clim_rs_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     #random effects
                     (1+z.ppt_pJunSep|FVS_LOC_CD)+(1+z.DIA_C|TRE_CN:FVS_LOC_CD)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
anova(clim_red_pp,clim_rs_pp)
#summary(clim_rs_pp)
```


## Model Diagnostics

```{r echo=FALSE}
#tree ring model
an_al_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    z.CR_fvs+I(z.CR_fvs^2)+
                    #climate
                    #competition/density
                    z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                    z.sin+z.cos+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
an_red_pp <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                    #climate
                    #competition/density
                    z.BAL+ #remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                        data = varmt_pp_z)
#tr + climate model
clim_al_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.CR_fvs+I(z.CR_fvs^2)+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+z.PCCF+#z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+I(z.SLOPE^2)+
                     z.sin+z.cos+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
clim_red_pp <- lmer(log(dds)~
                       #tree variables
                       z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                       #climate
                       z.ppt_pJunSep*z.tmax_JunAug+
                       #competition/density
                       z.BAL+ #remove /100 due to standardization
                       #site variables
                       z.SICOND+z.SLOPE+
                       #z.solrad_MayAug+
                       #random effects
                       (1+z.DIA_C|TRE_CN)+(1|Year),
                     control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                     data = varmt_pp_z)
#normals
clim_n_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.DIA_C:z.BAL+
                     #climate
                     z.ppt_pJunSep+z.tmax_JunAug+#interaction significant
                     z.n_ppt+z.n_tmp+
                     z.n_ppt:z.ppt_pJunSep+
                     z.n_tmp:z.ppt_pJunSep+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
clim_int_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     z.DIA_C:z.BAL+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+z.SLOPE+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
clim_nint_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #climate
                     z.ppt_pJunSep+z.tmax_JunAug+#interaction significant
                     z.n_ppt+z.n_tmp+
                     z.n_ppt:z.ppt_pJunSep+
                     z.n_tmp:z.ppt_pJunSep+
                     #competition/density
                     z.BAL+ #remove /100 due to standardization
                     z.BAL:z.n_ppt+
                     #site variables
                     z.SICOND+z.SLOPE+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
AIC(an_al_pp,an_red_pp,clim_al_pp,clim_red_pp,clim_n_pp,clim_nint_pp)
```

### Test of Normality

The linear mixed effect model assumes a Gaussian (normal) distribution. To test that assumption, a quantile-quantile (qq) plot will plot our distribution against a normal distribution.


```{r echo=FALSE}
#residuals
par(mfrow=c(2,2))

#full annual
resid_annual<- residuals(annual_pp,type="pearson",scaled=TRUE)
qqnorm(resid_annual,main="QQ plot of Full Annual")
qqline(resid_annual)
hist(resid_annual, breaks = 50, main = "Histogram of Full Annual Residuals")

#annual reduced
resid_annred <- residuals(an_red_pp,type="pearson",scaled=TRUE)
qqnorm(resid_annred,main="QQ plot of Reduced Annual")
qqline(resid_annred)
hist(resid_annred, breaks = 50, main = "Histogram of Reduced Annual Residuals")

#clim_16
resid_clm<- residuals(clim_al_pp,type="pearson",scaled=TRUE)
qqnorm(resid_clm,main="QQ plot of Full Climate")
qqline(resid_clm)
hist(resid_clm, breaks = 50, main = "Histogram of Full Climate Residuals")

#clim_16_red
resid_clmred <- residuals(clim_red_pp,type="pearson",scaled=TRUE)
qqnorm(resid_clmred,main="QQ plot of Reduced Climate")
qqline(resid_clmred)
hist(resid_clmred, breaks = 50, main = "Histogram of Reduced Climate Residuals")
```

### Test of Homoscedasticity

```{r include=FALSE}
library(gplots)
```

To test if my transformed residuals have a constant variance with a mean of zero, I will plot transformed residuals vs predicted values.

```{r}
par(mfrow=c(2,2))
pred_annual <- predict(annual_pp, type="response")
plotLowess(resid_annual~pred_annual, ylab="Residuals",xlab="Predicted", main="Full Annual")
pred_annred <- predict(an_red_pp, type="response")
plotLowess(resid_annred~pred_annred, ylab="Residuals",xlab="Predicted", main="Reduced Annual")
pred_clm <- predict(clim_16_pp, type="response")
plotLowess(resid_clm~pred_clm, ylab="Residuals",xlab="Predicted", main="Full Climate")
pred_clmred <- predict(clim_red_pp, type="response")
plotLowess(resid_clmred~pred_clmred, ylab="Residuals",xlab="Predicted", main="Reduced Climate")
```

We can also test if residuals have a constant variance against predictor variables. Below plots are only given for the reduced climate model, but more models can be plotted.

```{r echo=FALSE}
par(mfrow=c(2,2))
#dbh
plotLowess(resid_clmred~z.DIA_C,data = varmt_pp_z,ylab="Residuals",main="Climate Reduced: DBH")
#plotLowess(resid_lmm1~z.DIA_C,data = varmt_pp_z,ylab="Residuals",main="LMM1")
#CR
plotLowess(resid_clmred~z.CR_fvs,data = varmt_pp_z,ylab="Residuals",main="Climate Reduced: CR")
#plotLowess(resid_lmm1~z.CR_fvs,data = varmt_pp_z,ylab="Residuals",main="LMM1")
#precip
plotLowess(resid_clmred~z.ppt_pJunSep,data = varmt_pp_z,ylab="Residuals",main="Climate Reduced: Precip") 
#plotLowess(resid_lmm1~z.ppt_pJunSep,data = varmt_pp_z,ylab="Residuals",main="LMM1") 
#temp
plotLowess(resid_clmred~z.tmax_JunAug,data = varmt_pp_z,ylab="Residuals",main="Climate Reduced: Temp")
#plotLowess(resid_lmm1~z.tmax_JunAug,data = varmt_pp_z,ylab="Residuals",main="LMM1")
#CCF
plotLowess(resid_clmred~z.CCF,data = varmt_pp_z,ylab="Residuals",main="Climate Reduced: CCF")
#plotLowess(resid_lmm1~z.CCF,data = varmt_pp_z,ylab="Residuals",main="LMM1")
#SI
plotLowess(resid_clmred~z.SICOND,data = varmt_pp_z,ylab="Residuals",main="Climate Reduced: SI")
#plotLowess(resid_lmm1~z.SICOND,data = varmt_pp_z,ylab="Residuals",main="LMM1")
#Slope
plotLowess(resid_clmred~z.SLOPE,data = varmt_pp_z,ylab="Residuals",main="Climate Reduced: Slope")
#plotLowess(resid_lmm1~z.SLOPE,data = varmt_pp_z,ylab="Residuals",main="LMM1")
```


### Mining

```{r}
#reduced models
#BALIVE


```


## Visualization

```{r include=FALSE}
library(broom.mixed)
library(dotwhisker)
```

```{r echo=FALSE, message=FALSE,warning=FALSE}
full_an_pp <-  tidy(an_al_pp) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Full Annual")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.BAL = "BAL",
                       z.CCF = "CCF",
                       z.SDI = "SDI",
                       z.PCCF = "PCCF",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL"))
red_an_pp <-  tidy(an_red_pp) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Reduced Annual")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL"))
full_clim_pp <-  tidy(clim_al_pp) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Full Climate")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.ppt_pJunSep = "Precip",
                       z.tmax_JunAug = "Temp",
                       "z.ppt_pJunSep:z.tmax_JunAug" = "Precip:Temp",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.PCCF = "PCCF",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL"))
red_clim_pp <-  tidy(clim_red_pp) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Reduced Climate")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.ppt_pJunSep = "Precip",
                       z.tmax_JunAug = "Temp",
                       "z.ppt_pJunSep:z.tmax_JunAug" = "Precip:Temp",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL"))
red_n_pp <-  tidy(clim_n_pp) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Climate Normals")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.CR = "CR",
                       z.ppt_pJunSep = "Precip",
                       z.tmax_JunAug = "Temp",
                       "z.ppt_pJunSep:z.tmax_JunAug" = "Precip:Temp",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL",
                       z.n_ppt = "Precip Normal",
                       z.n_tmp = "Temp Normal",
                       "z.DIA_C:z.BAL" = "DIA:BAL",
                       "z.ppt_pJunSep:z.n_ppt" = "Precip:Precip Normal",
                       "z.ppt_pJunSep:z.n_tmp" = "Precip:Temp Normal"))
red_nint_pp <-  tidy(clim_nint_pp) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Normals + Interactions")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR_fvs = "CR",
                       "I(z.CR_fvs^2)" = "CR^2",
                       z.CR = "CR",
                       z.ppt_pJunSep = "Precip",
                       z.tmax_JunAug = "Temp",
                       "z.ppt_pJunSep:z.tmax_JunAug" = "Precip:Temp",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SICOND = "SICOND",
                       z.SLOPE = "SL",
                       "I(z.SLOPE^2)" = "SL^2",
                       z.sin = "sin(ASP-0.7854)*SL",
                       z.cos = "cos(ASP-0.7854)*SL",
                       z.n_ppt = "Precip Normal",
                       z.n_tmp = "Temp Normal",
                       "z.ppt_pJunSep:z.n_ppt" = "Precip:Precip Normal",
                       "z.ppt_pJunSep:z.n_tmp" = "Precip:Temp Normal",
                       "z.tmax_JunAug:z.n_ppt" = "Temp:Precip Normal",
                       "z.n_ppt:z.BAL" = "BAL:Precip Normal"))
models_pp <- full_join(full_an_pp,red_an_pp) %>%
  full_join(.,full_clim_pp) %>%
  full_join(.,red_clim_pp)%>%
  full_join(.,red_n_pp)%>%
  full_join(.,red_nint_pp)
mod_pp <- dwplot(models_pp, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
       # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/pp_mods.png",mod_pp,
       height = 5, width = 8, units = "in")

#change shapes
models_pp <- models_pp %>% filter(term != "(Intercept)") %>% droplevels()
models_pp$model <- factor(models_pp$model, levels = c("Full Annual", "Reduced Annual", "Full Climate",
                                                      "Reduced Climate", "Climate Normals","Normals + Interactions"))
pp_mods <- ggplot(data = models_pp, aes(x = term, y = estimate, shape = model)) + 
  geom_linerange(aes(ymax = estimate + std.error, ymin = estimate - std.error), 
                position = position_dodge(width = 1), color = "grey58") +
  geom_point(position = position_dodge(width = 1), size = 2) +
  scale_shape_manual(values=c(16,1,17,2,3,8)) +# change shape
  scale_x_discrete(limits = rev(levels(models_pp$term))) +
  geom_hline(yintercept = 0, colour = "grey60", linetype = 2) +
  coord_flip() +
  theme_bw() + labs(title = "a)", y = "Standardized Coefficient Estimate", x="Predictor") +
  theme(#plot.title = element_text(face="bold"),
        legend.position = c(0.76,0.5),
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)

ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/pp_mods.png",
       height = 10, width = 6, units = "in")
```


## Interpretation

We can start to understand the influence of the covariate on the response variable, tree growth, with the `effects` package. Keeping all other variables constant, it shows the effect of the covariate on the reponse.

```{r include=FALSE}
library(effects)
library(sjPlot)
library(sjmisc)
library(grid)
library(gridExtra)
```

### Diameter at Breast Height

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.DIA_C",annual_pp),xlab = "DBH",main = "Full Annual")
plot(effect("z.DIA_C",an_red_pp),xlab = "DBH",main = "Reduced Annual")
plot(effect("z.DIA_C",clim_16_pp),xlab = "DBH",main = "Full Climate")
plot(effect("z.DIA_C",clim_red_pp),xlab = "DBH",main = "Reduced Climate")
```

### Crown Ratio

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.CR_fvs",annual_pp),xlab = "Crown Ratio",main = "Full Annual")
plot(effect("z.CR_fvs",an_red_pp),xlab = "Crown Ratio",main = "Reduced Annual")
plot(effect("z.CR_fvs",clim_16_pp),xlab = "Crown Ratio",main = "Full Climate")
plot(effect("z.CR_fvs",clim_red_pp),xlab = "Crown Ratio",main = "Reduced Climate")
```

### Crown Competition Factor

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.CCF",annual_pp),xlab = "CCF",main = "Full Annual")
plot(effect("z.CCF",an_red_pp),xlab = "CCF",main = "Reduced Annual")
plot(effect("z.CCF",clim_16_pp),xlab = "CCF",main = "Full Climate")
plot(effect("z.CCF",clim_red_pp),xlab = "CCF",main = "Reduced Climate")
```

### Site Index

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.SICOND",annual_pp),xlab = "Site Index",main = "Full Annual")
plot(effect("z.SICOND",an_red_pp),xlab = "Site Index",main = "Reduced Annual")
plot(effect("z.SICOND",clim_16_pp),xlab = "Site Index",main = "Full Climate")
plot(effect("z.SICOND",clim_red_pp),xlab = "Site Index",main = "Reduced Climate")
```

### Slope

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.SLOPE",annual_pp),xlab = "Slope",main = "Full Annual")
plot(effect("z.SLOPE",an_red_pp),xlab = "Slope",main = "Reduced Annual")
plot(effect("z.SLOPE",clim_16_pp),xlab = "Slope",main = "Full Climate")
plot(effect("z.SLOPE",clim_red_pp),xlab = "Slope",main = "Reduced Climate")
```

### Radiation

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.sin",annual_pp),xlab = "sin(Aspect-0.7854)*Slope",main = "Full Annual")
plot(effect("z.sin",an_red_pp),xlab = "sin(Aspect-0.7854)*Slope",main = "Reduced Annual")
plot(effect("z.sin",clim_16_pp),xlab = "sin(Aspect-0.7854)*Slope",main = "Full Climate")
plot(effect("z.sin",clim_red_pp),xlab = "sin(Aspect-0.7854)*Slope",main = "Reduced Climate")
```

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(2,2))
plot(effect("z.cos",annual_pp),xlab = "cos(Aspect-0.7854)*Slope",main = "Full Annual")
plot(effect("z.cos",an_red_pp),xlab = "cos(Aspect-0.7854)*Slope",main = "Reduced Annual")
plot(effect("z.cos",clim_16_pp),xlab = "cos(Aspect-0.7854)*Slope",main = "Full Climate")
plot(effect("z.cos",clim_red_pp),xlab = "cos(Aspect-0.7854)*Slope",main = "Reduced Climate")
```

### Climate

```{r echo=FALSE, fig.width=3.5,fig.height=3}
par(mfrow=c(1,2))
plot(effect("z.ppt_pJunSep",clim_16_pp),xlab = "Precipitation",main = "Full Climate")
plot(effect("z.ppt_pJunSep",clim_red_pp),xlab = "Precipitation",main = "Reduced Climate")
plot(effect("z.tmax_JunAug",clim_16_pp),xlab = "Temperature",main = "Full Climate")
plot(effect("z.tmax_JunAug",clim_red_pp),xlab = "Temperature",main = "Reduced Climate")
```
```{r echo}
plot(effect("z.ppt_pJunSep:z.tmax_JunAug",clim_16_pp),xlab = "Interaction",main = "Full Climate")
plot(effect("z.ppt_pJunSep:z.tmax_JunAug",clim_red_pp),xlab = "Interaction",main = "Reduced Climate")
```


```{r}
plot_model(clim_red_pp, type = "int", mdrt.values = "meansd")
plot_model(clim_rsp, type = "int", mdrt.values = "meansd")
```

### All

```{r}
d <- plot(effect("z.DIA_C",clim_red_pp),xlab = "DBH",main="")
sdi <- plot(effect("z.BAL",clim_red_pp),xlab = "BAL",main="")
si <- plot(effect("z.SICOND",clim_red_pp),xlab = "Site Index",main="")
#sl <- plot(effect("z.SLOPE",clim_red_pp),xlab = "Slope",main="")
ppt <- plot(effect("z.ppt_pJunSep",clim_n_pp),xlab = "Precipitation",main="")
tmp <- plot(effect("z.tmax_JunAug",clim_n_pp),xlab = "Temperature",main="")
all_coef <- arrangeGrob(d,c,sdi,si,sl,ppt,tmp,nrow=3)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/eff_pp.png", all_coef,scale = .5)
```

### Interaction

```{r}
clint <- plot_model(clim_red_pp, type = "pred", terms = c("z.ppt_pJunSep","z.tmax_JunAug"),
                    axis.title = c("Precip","dds"), title = "b) Temp", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  geom_rug(data = varmt_pp_z, aes(x = z.ppt_pJunSep), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
nint1 <- plot_model(clim_n_pp, type = "pred", terms = c("z.ppt_pJunSep","z.n_ppt"),
                    axis.title = c("Precip","dds"), title = "c) Precip Normal", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  geom_rug(data = varmt_pp_z, aes(x = z.ppt_pJunSep), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
nint2 <- plot_model(clim_n_pp, type = "pred", terms = c("z.ppt_pJunSep","z.n_tmp"),
                    axis.title = c("Precip","dds"), title = "d) Temp Normal", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + labs(y = expression(paste("dds (i", n^2, ")"))) +
  geom_rug(data = varmt_pp_z, aes(x = z.ppt_pJunSep), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
#nint3 <- plot_model(clim_int_pp, type = "pred", terms = c("z.BAL","z.DIA_C"),
#                    axis.title = c("BAL","dds"), legend.title = "DIA", title = "")
nint4 <- plot_model(clim_nint_pp, type = "pred", terms = c("z.BAL","z.n_ppt"),
                    axis.title = c("BAL","dds"), title = "e) Precip Normal", show.legend = F,
                    colors = c("grey72", "gray47", "gray0")) +
  theme_bw() + #theme(legend.position = c(0.1,0.85))
  labs(y = expression(paste("dds (i", n^2, ")"))) +
  geom_rug(data = varmt_pp_z, aes(x = z.BAL), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")
all_int <- grid.arrange(clint,nint1,nint2,nint4,ncol = 2)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/eff_int_pp.png", all_int)

clint_leg <- plot_model(clim_red_pp, type = "pred", terms = c("z.ppt_pJunSep","z.tmax_JunAug"),
                    axis.title = c("Precip","dds"), legend.title = "Interaction Key", title = "a)",
                    colors = c("grey72", "gray47", "gray0")) + 
  scale_color_manual(values = c("grey72", "gray47", "gray0"),labels = c("-1 SD", "mean", "+1 SD")) 
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/int_leg.png", clint_leg)

#presentation
precip_int <- plot_model(clim_n_pp, type = "pred", terms = c("z.ppt_pJunSep","z.n_ppt"),
                    axis.title = c("Precipitation","growth"),
                    colors = c("#CC0000", "#660099", "#3366FF")) +
  theme_bw()
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/precip_int.png", precip_int,
       width = 5, height = 4, units = "in")
n_bal <- plot_model(clim_nint_pp, type = "pred", terms = c("z.BAL","z.n_ppt"),
                    axis.title = c("Competition","dds"),
                    colors = c("#CC0000", "#660099", "#3366FF")) +
  theme_bw()
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/n_bal.png", n_bal,
       width = 5, height = 4, units = "in")

#all together
plot_pp <- list(pp_mods,clint,nint1,nint2,nint4)
lay = rbind(c(1,1,2,3),
             c(1,1,4,5),
             c(1,1,6,7))
pp_plot <- grid.arrange(grobs = plot_pp, layout_matrix = lay)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/pp_coef.png", pp_plot, 
       height = 8, width = 12, units = "in")
```


```{r}
#plot_model relies on ggeffects so use that to make own function
plot_int <- function(data,term1,term2,model){
  require(tidyverse) #obvi
  require(MKmisc) #to get CI
  require(ggeffects) #to predict interaction effect
  
  #find the 95% confidence intervals for 25, 50, 75 percent quantiles
  t2 <- data[,term2]
  #ci10_df <- quantileCI(t2, prob = 0.1)
  ci25_df <- quantileCI(t2, prob = 0.25)
  ci50_df <- quantileCI(t2, prob = 0.50)
  ci75_df <- quantileCI(t2, prob = 0.75)
  #ci90_df <- quantileCI(t2, prob = 0.90)
  #consider adding more quantiles
  
  #make new dataframe
  df <- data.frame(quant = c(25,50,75),
                   estimate = c(ci25_df$estimate[1],ci50_df$estimate[1],
                                ci75_df$estimate[1]),
                   CIlower = c(min(ci25_df$conf.int),min(ci50_df$conf.int),
                               min(ci75_df$conf.int)),
                   CIupper = c(max(ci25_df$conf.int),max(ci50_df$conf.int),
                               max(ci75_df$conf.int)))
  
  #find the values of the first term that are observed between CI above
  for(i in 1:nrow(df)){
    df_red <- data %>% filter(between(t2,df$CIlower[i],df$CIupper[i]))
    t1 <- df_red[,term1]
    df$xmin[i] <- min(t1, na.rm = T)
    df$xmax[i] <- max(t1, na.rm = T)
  }
  
  #create string to pass to predict function
  #first interaction term
  x_l <- c(df$xmin,df$xmax) #list
  x_s <- paste0(x_l, collapse=",") #string
  pred_t1 <- paste0(term1, " [", x_s, "]")
  #second interaction term
  estimate <- paste0(df$estimate, collapse=",")
  pred_t2 <- paste0(term2," [", estimate, "]")
  
  #predict interaction
  int_df <- ggpredict(model, terms = c(pred_t1, pred_t2))
  
  #interaction where observations exist
  df$group <- factor(df$estimate)
  int_df_red <- int_df %>%
    full_join(.,df) %>% #join dfs to filter by observations
    filter(x >= (xmin-0.01) & x <= (xmax+0.01)) #probably should be a better way to do this
  #for example x == xmin |(OR) x == xmax but that doesn't work
  #so subtract/add a little to make work
  
   plot <- ggplot(int_df_red, aes(x = x, y = predicted, color = group)) +
    geom_line() +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), linetype = 0, alpha = 0.2) +
    scale_color_manual(labels = c(25, 50, 75), values = c("grey72", "gray47", "gray0")) +
    theme_bw()+
    labs(y = expression(paste("dds (i", n^2, ")")),
         color = "Quantile")
  
  return(plot)
}

clint_plt <- plot_int(data = varmt_pp_z, term1 = "z.ppt_pJunSep", term2 =  "z.tmax_JunAug", model = clim_red_pp)
clint_plt <- clint_plt +
  labs(x = "Precip", title = "b) Temp") +
  theme(legend.position = "none")

nint1_plt <- plot_int(data = varmt_pp_z, term1 = "z.ppt_pJunSep", term2 = "z.n_ppt", model = clim_n_pp)
nint1_plt <- nint1_plt +
    labs(x = "Precip",  title = "c) Precip Normal") +
  theme(legend.position = "none")

nint2_plt <- plot_int(data = varmt_pp_z, term1 = "z.ppt_pJunSep", term2 = "z.n_tmp", model = clim_n_pp) 
nint2_plt <- nint2_plt +
    labs(x = "Precip",  title = "d) Temp Normal") +
  theme(legend.position = "none")

nint4_plt <- plot_int(data = varmt_pp_z, term1 = "z.BAL", term2 = "z.n_ppt", model = clim_nint_pp) 
nint4_plt <- nint + #nint4_plt +; might need to fix code to add more variables if there's only one obs
    labs(x = "BAL",  title = "e) Precip Normal") +
  theme(legend.position = "none") #+
  #geom_rug(data = varmt_pp_z, aes(x = z.BAL), inherit.aes = FALSE,
           alpha = 0.1, sides = "b")

all_int <- grid.arrange(clint_plt,nint1_plt,nint2_plt,nint4_plt,ncol = 2)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/eff_int_df.png", all_int, scale = .5)

#join interactions with coefficient plot
plot_pp <- list(pp_mods,clint_plt,nint1_plt,
                nint2_plt,nint4_plt)
lay = rbind(c(1,1,2,3),
             c(1,1,4,5),
             c(1,1,6,7))
pp_plot <- grid.arrange(grobs = plot_pp, layout_matrix = lay)
ggsave(filename = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/images/pp_coef.png", pp_plot, 
       height = 8, width = 12, units = "in")

```


### Random Effects

```{r}
plot_model(clim_rs_pp, type = "re")
```

```{r}
sample_tre <- sample(varmt_pp_z$TRE_CN, size = 9)
pp1 <- ggpredict(clim_mod_pp,
       terms=c("z.DIA_C","TRE_CN [sample_tre]"), type="random")
plot(pp1)
pp2 <- ggpredict(clim_rs_pp,
       terms=c("z.DIA_C","TRE_CN [sample_tre]"), type="random")
plot(pp2)
```


```{r}
pp1 <- ggpredict(clim_mod_pp,
       terms=c("z.ppt_pJunSep","TRE_CN [sample_tre]"), type="random")
plot(pp1)
pp2 <- ggpredict(clim_rs_pp,
       terms=c("z.ppt_pJunSep","TRE_CN [sample_tre]"), type="random")
plot(pp2)
```

```{r}
pp1 <- ggpredict(clim_mod_pp,
       terms=c("z.tmax_JunAug","TRE_CN [sample_tre]"), type="random")
plot(pp1)
pp2 <- ggpredict(clim_rs_pp,
       terms=c("z.tmax_JunAug","TRE_CN [sample_tre]"), type="random")
plot(pp2)
```

