---
title: "Climate Inference"
author: "Courtney Giebink"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Climate Inference

There are a couple ways we could explore the effect of climate on growth: 1) time varying fixed effects, 2) random effects and 3) climate normals fixed effects. Let's look at the climate interaction of the fixed effects. We can also try to fit a more complex random effects structure and explore the correlation between random intercepts and slopes. If the correlation is negative, it means that intercepts larger than the marginal/population mean have a weaker slope. In other words, if trees within a forest have better growth than average, the effect of precipitation is less. If the correlation is positive, it means that intercepts larger than the marginal/population mean have a steeper slope. In other words, if trees within a forest have better growth than average, the effect of precipitation is more. 

```{r include=FALSE}
library(tidyverse)
library(lme4)
library(lmerTest)
library(sjPlot)
library(sjmisc)
```


## Douglas fir

```{r include=FALSE}
load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_df_z.Rdata")
```

Number of trees per forest code:

```{r echo=FALSE}
glmm_df_z %>%
  ungroup() %>%
  dplyr::select(TRE_CN,FVS_LOC_CD) %>%
  distinct() %>%
  group_by(FVS_LOC_CD) %>%
  summarize(n_tre = length(unique(TRE_CN)))
```

The models below are having difficulty converging. It might be due to not enough information, or factors, within each level. I think should be 5? When I drop FVS_LOC_CD 409, the model is able to converge.

```{r warning=FALSE}
glmm_df_red <- glmm_df_z %>%
  filter(FVS_LOC_CD != 409)
```

A likelihood ratio test will determine if the random effects significantly improve model fit. Null hypothesis: the reduced model is good enough.

```{r}
clim_mod_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #z.solrad_MayAug+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
clim_rs_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+ (1+z.ppt_pJunSep|FVS_LOC_CD:TRE_CN)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_df_z)
anova(clim_mod_df,clim_rs_df)
#summary(clim_mod_df)$coef
VarCorr(clim_mod_df)
#summary(clim_rs_df)$coef
VarCorr(clim_rs_df)
```

What about climate normals:
```{r}
clim_n_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep+z.tmax_FebJul+
                 #z.ppt_pJunSep:z.tmax_FebJul+
                 z.n_ppt+
                 z.n_tmp+
                 z.ppt_pJunSep:z.n_ppt+
                 #z.n_tmp:z.tmax_FebJul+
                 z.n_ppt:z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
AIC(clim_mod_df,clim_n_df)
summary(clim_n_df)$coef
```


Different model structure influence on fixed effects:
```{r include=FALSE}
library(broom.mixed)
library(dotwhisker)
library(gridExtra)
library(grid)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
clim_df <-  tidy(clim_mod_df) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Main RE")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF",
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope"))
rs_df <-  tidy(clim_rs_df) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Add RE")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope"))
n_df <-  tidy(clim_n_df) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Climate Normal")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Climate Interaction",
                       z.n_ppt = "Precip Normal",
                       z.n_tmp = "Temp Normal",
                       "z.ppt_pJunSep:z.n_ppt" = "Precip Interaction",
                       "z.tmax_FebJul:z.n_tmp" = "Temp Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope"))
models_df <- full_join(clim_df,rs_df) %>%
  full_join(.,n_df)
dwplot(models_df, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
       # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  ggtitle("Douglas Fir") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
```




```{r echo=FALSE,message=FALSE, warning=FALSE,fig.show="hold", out.width="50%"}
par(mfrow=c(2,2))
plot_model(clim_mod_df, type = "pred", terms = c("z.ppt_pJunSep", "z.tmax_FebJul"),
           title = "Douglas fir - reduced random effects")
plot_model(clim_rs_df, type = "pred", terms = c("z.ppt_pJunSep", "z.tmax_FebJul"),
           title = "Douglas fir - full random effects")
plot_model(clim_n_df, type = "pred", terms = c("z.ppt_pJunSep", "z.n_ppt"),
           title = "Douglas fir - climate normals")
plot_model(clim_n_df, type = "pred", terms = c( "z.tmax_FebJul","z.n_ppt"),
           title = "Douglas fir - climate normals")
```


## Ponderosa pine

```{r include=FALSE}
load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_pp_z.Rdata")
```

```{r echo=FALSE}
varmt_pp_z %>%
  ungroup() %>%
  dplyr::select(TRE_CN,FVS_LOC_CD) %>%
  distinct() %>%
  group_by(FVS_LOC_CD) %>%
  summarize(n_tre = length(unique(TRE_CN)))
```

```{r}
clim_mod_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
clim_rs_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1+z.tmax_JunAug|FVS_LOC_CD:TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = varmt_pp_z)
anova(clim_mod_pp,clim_rs_pp)
#summary(clim_mod_pp)$coef
VarCorr(clim_mod_pp)
#summary(clim_rs_pp)$coef
VarCorr(clim_rs_pp)
```

Climate normal:
```{r}
clim_n_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #climate
                     z.ppt_pJunSep+z.tmax_JunAug+
                     z.ppt_pJunSep:z.tmax_JunAug+#interaction significant
                     z.n_ppt+z.n_tmp+
                     z.ppt_pJunSep:z.n_ppt+
                     z.ppt_pJunSep:z.n_tmp+
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     #site variables
                     #z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
summary(clim_n_pp)$coef
AIC(clim_mod_pp,clim_n_pp)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
clim_pp <-  tidy(clim_mod_pp) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Main RE")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_JunAug = "Temperature",
                       "z.ppt_pJunSep:z.tmax_JunAug" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF",
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope"))
rs_pp <-  tidy(clim_rs_pp) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Add RE")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_JunAug = "Temperature",
                       "z.ppt_pJunSep:z.tmax_JunAug" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope"))
n_pp <-  tidy(clim_n_pp) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Climate Normal")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_JunAug = "Temperature",
                       "z.ppt_pJunSep:z.tmax_JunAug" = "Climate Interaction",
                       z.n_ppt = "Precip Normal",
                       z.n_tmp = "Temp Normal",
                       "z.ppt_pJunSep:z.n_ppt" = "Precip Interaction",
                       "z.ppt_pJunSep:z.n_tmp" = "precip:temp_norm",
                       "z.tmax_JunAug:z.n_tmp" = "Temp Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope"))
models_pp <- full_join(clim_pp,rs_pp) %>%
  full_join(.,n_pp)
dwplot(models_pp, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
       # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  ggtitle("Ponderosa Pine") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
```


```{r echo=FALSE,message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
par(mfrow=c(2,2))
plot_model(clim_mod_pp, type = "pred", terms = c("z.ppt_pJunSep", "z.tmax_JunAug"),
           title = "Ponderosa pine - reduced random effects")
plot_model(clim_rs_pp, type = "pred", terms = c("z.ppt_pJunSep", "z.tmax_JunAug"),
           title = "Ponderosa pine - full random effects")
plot_model(clim_n_pp, type = "pred", terms = c("z.ppt_pJunSep", "z.tmax_JunAug"),
           title = "Ponderosa pine - climate normal")
plot_model(clim_n_pp, type = "pred", terms = c("z.ppt_pJunSep", "z.n_ppt"),
           title = "Ponderosa pine - climate normal")
plot_model(clim_n_pp, type = "pred", terms = c("z.ppt_pJunSep", "z.n_tmp"),
           title = "Ponderosa pine - climate normal")
```


## Engelmann spruce

```{r include=FALSE}
load(file = "/home/courtney/Documents/Masters/Research/Utah/UT_FVS/data/formatted/glmm_es_z.Rdata")
```


```{r echo=FALSE}
varmt_es_z %>%
  ungroup() %>%
  dplyr::select(TRE_CN,FVS_LOC_CD) %>%
  distinct() %>%
  group_by(FVS_LOC_CD) %>%
  summarize(n_tre = length(unique(TRE_CN)))
```

```{r}
clim_mod_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
clim_rs_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1+z.ppt_pJunSep|FVS_LOC_CD:TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = varmt_es_z)
anova(clim_mod_es,clim_rs_es)
#summary(clim_mod_es)$coef
VarCorr(clim_mod_es)
#summary(clim_rs_es)$coef
VarCorr(clim_rs_es)
```

Climate normals:
```{r}
clim_n_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep+z.tmax_pAug+
                 #z.ppt_pJunSep:z.tmax_pAug+ #significant interaction
                 z.n_ppt+z.n_tmp+
                 z.n_tmp:z.ppt_pJunSep+
                 z.n_ppt:z.ppt_pJunSep+
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
summary(clim_n_es)$coef
AIC(clim_mod_es,clim_n_es)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
clim_es <-  tidy(clim_mod_es) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Main RE")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_pAug = "Temperature",
                       "z.ppt_pJunSep:z.tmax_pAug" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF",
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2"))
rs_es <-  tidy(clim_rs_es) %>% 
  filter(effect == "fixed") %>%
  select(term,estimate,std.error) %>%
  mutate(model = "Add RE")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_pAug = "Temperature",
                       "z.ppt_pJunSep:z.tmax_pAug" = "Climate Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2"))
n_es <-  tidy(clim_n_es) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Climate Normal")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_pAug = "Temperature",
                       "z.ppt_pJunSep:z.tmax_pAug" = "Climate Interaction",
                       z.n_ppt = "Precip Normal",
                       z.n_tmp = "Temp Normal",
                       "z.ppt_pJunSep:z.n_ppt" = "Precip Interaction",
                       "z.ppt_pJunSep:z.n_tmp" = "Precip:temp_norm",
                       "z.tmax_pAug:z.n_tmp" = "Temp Interaction",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope",
                       "I(z.SLOPE^2)" = "Slope^2"))
models_es <- full_join(clim_es,rs_es) %>%
  full_join(.,n_es)
dwplot(models_es, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
       # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  ggtitle("Engelmann Spruce") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
```


```{r echo=FALSE,message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
par(mfrow=c(2,2))
plot_model(clim_mod_es, type = "pred", terms = c("z.ppt_pJunSep", "z.tmax_pAug"),
           title = "Engelmann spruce - reduced random effects")
plot_model(clim_rs_es, type = "pred", terms = c("z.ppt_pJunSep", "z.tmax_pAug"),
           title = "Engelmann spruce - full random effects")
#plot_model(clim_n_es, type = "pred", terms = c("z.ppt_pJunSep", "z.tmax_pAug"),
#           title = "Engelmann spruce - climate normals")
plot_model(clim_n_es, type = "pred", terms = c("z.ppt_pJunSep", "z.n_ppt"),
           title = "Engelmann spruce - climate normals")
plot_model(clim_n_es, type = "pred", terms = c("z.ppt_pJunSep", "z.n_tmp"),
           title = "Engelmann spruce - climate normals")

```

## Other interactions?

Should we consider other interactions, outside of FVS.

### Douglas fir


```{r}
clim_int1_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.DIA_C:z.tmax_FebJul+
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
clim_int2_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.SICOND:z.tmax_FebJul+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
clim_int3_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.SLOPE:z.tmax_FebJul+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
AIC(clim_mod_df,clim_int1_df,clim_int2_df,clim_int3_df)
```

```{r echo=FALSE,message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
par(mfrow=c(2,2))
plot_model(clim_int1_df, type = "pred", terms = c("z.tmax_FebJul","z.DIA_C"),
           mdrt.values = "meansd",title = "Douglas fir")
plot_model(clim_int2_df, type = "pred", terms = c("z.tmax_FebJul","z.SICOND"),
           mdrt.values = "meansd", title = "Douglas fir")
plot_model(clim_int3_df, type = "pred", terms = c("z.tmax_FebJul","z.SLOPE"),
           mdrt.values = "meansd", title = "Douglas fir")
```

```{r}
clim_intn_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 #z.n_ppt+
                 z.n_tmp+
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+#remove /100 due to standardization
                 z.SDI:z.n_tmp+
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
AIC(clim_mod_df,clim_intn_df)
summary(clim_intn_df)$coef
```

```{r}
plot_model(clim_intn_df, type = "int", mdrt.values = "meansd",
           title = "Douglas fir")
```

```{r}
clim_rint1_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.DIA_C:z.tmax_FebJul+
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+ (z.ppt_pJunSep|FVS_LOC_CD:TRE_CN)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_red)
clim_rint2_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.SLOPE:z.tmax_FebJul+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+ (z.ppt_pJunSep|FVS_LOC_CD:TRE_CN)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_red)
clim_rint3_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.SICOND:z.ppt_pJunSep+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+ (z.ppt_pJunSep|FVS_LOC_CD:TRE_CN)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_red)
clim_rint13_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.DIA_C:z.tmax_FebJul+
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.SICOND:z.ppt_pJunSep+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+ (z.ppt_pJunSep|FVS_LOC_CD:TRE_CN)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_red)
AIC(clim_mod_df,clim_rs_df,clim_rint1_df,clim_rint2_df,clim_rint3_df,clim_rint13_df)
```

```{r echo=FALSE,message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
par(mfrow=c(2,2))
plot_model(clim_rint1_df, type = "pred", terms = c("z.tmax_FebJul","z.DIA_C"),
           mdrt.values = "meansd",title = "Douglas fir")
plot_model(clim_rint2_df, type = "pred", terms = c("z.tmax_FebJul","z.SLOPE"),
           mdrt.values = "meansd", title = "Douglas fir")
plot_model(clim_rint3_df, type = "pred", terms = c("z.ppt_pJunSep","z.SICOND"),
           mdrt.values = "meansd", title = "Douglas fir")
```


### Ponderosa pine

```{r}
clim_int_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     z.CCF:z.ppt_pJunSep+
                     z.CCF:z.tmax_JunAug+
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
AIC(clim_mod_pp,clim_int_pp)
```

```{r echo=FALSE,message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
par(mfrow=c(2,2))
plot_model(clim_int_pp, type = "int", mdrt.values = "meansd",
           title = "Ponderosa pine")
```


```{r}
clim_rint1_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     z.CCF:z.ppt_pJunSep+
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1+z.tmax_JunAug|FVS_LOC_CD:TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
clim_rint2_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     z.CCF:z.tmax_JunAug+
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1+z.tmax_JunAug|FVS_LOC_CD:TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
AIC(clim_mod_pp,clim_rs_pp,clim_rint1_pp,clim_rint2_pp)
```

```{r echo=FALSE,message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
par(mfrow=c(2,2))
plot_model(clim_rint1_pp, type = "pred", terms = c("z.CCF","z.ppt_pJunSep"),
           mdrt.values = "meansd", title = "Ponderosa pine - rint")
plot_model(clim_rint2_pp, type = "pred", terms = c("z.CCF","z.tmax_JunAug"),
           mdrt.values = "meansd", title = "Ponderosa pine")
```


### Engelmann spruce

```{r}
clim_int1_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.DIA_C:z.ppt_pJunSep+
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
clim_int2_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 z.CR:z.ppt_pJunSep+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
clim_int3_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 z.BAL:z.ppt_pJunSep+
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
clim_int4_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.SICOND:z.ppt_pJunSep+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
clim_int5_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 z.SLOPE:z.ppt_pJunSep+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_mod_es,clim_int1_es,clim_int2_es,clim_int3_es,clim_int4_es,clim_int5_es)
```

```{r echo=FALSE,message=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}
par(mfrow=c(2,2))
plot_model(clim_int1_es, type = "pred", terms = c("z.DIA_C","z.ppt_pJunSep"),
           mdrt.values = "meansd", title = "Engelmann spruce")
plot_model(clim_int2_es, type = "pred", terms = c("z.CR", "z.ppt_pJunSep"),
           mdrt.values = "meansd", title = "Engelmann spruce")
plot_model(clim_int3_es, type = "pred", terms = c("z.BAL", "z.ppt_pJunSep"),
           mdrt.values = "meansd", title = "Engelmann spruce - int")
plot_model(clim_int4_es, type = "pred", terms = c("z.SICOND", "z.ppt_pJunSep"),
           mdrt.values = "meansd", title = "Engelmann spruce")
plot_model(clim_int5_es, type = "pred", terms = c("z.SLOPE", "z.ppt_pJunSep"),
           mdrt.values = "meansd", title = "Engelmann spruce")
```


```{r}
clim_rint_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 z.BAL:z.ppt_pJunSep+
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1+z.ppt_pJunSep|FVS_LOC_CD:TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_mod_es,clim_rs_es,clim_rint_es)
summary(clim_rint_es)$coef
```

```{r}
plot_model(clim_rint_es, type = "pred", terms = c("z.BAL","z.ppt_pJunSep"),
           mdrt.values = "meansd", title = "Engelmann spruce - rint")
```

```{r}
clim_frs_df <- lmer(log(dds)~
                  #tree variables
                 z.DIA_C+I(z.DIA_C^2)+#remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_FebJul+
                 #competition/density
                 z.SDI+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+ (1+z.ppt_pJunSep|FVS_LOC_CD)+(1|Year),
                control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
clim_frs_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1+z.tmax_JunAug|FVS_LOC_CD)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
clim_frs_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1+z.ppt_pJunSep|FVS_LOC_CD)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
AIC(clim_frs_df,clim_frs_pp,clim_frs_es)
```


## All

```{r}
clim_n1_df <- lmer(log(dds)~
                    #tree variables
                    z.DIA_C+ I(z.DIA_C^2)+#remove log due to standardization
                    z.CR+
                    #climate
                    z.ppt_pJunSep+z.tmax_FebJul+
                    #z.ppt_pJunSep:z.tmax_FebJul+
                    #z.n_ppt+
                    z.n_tmp+
                    z.ppt_pJunSep:z.n_ppt+
                    #z.n_tmp:z.tmax_FebJul+
                    z.n_ppt:z.tmax_FebJul+
                    #competition/density
                    z.SDI+#remove /100 due to standardization
                    #site variables
                    z.SICOND+z.SLOPE+
                    #random effects
                    (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_df_z)
n_df <-  tidy(clim_n1_df) %>% 
  filter(effect == "fixed") %>%
  dplyr::select(term,estimate,std.error) %>%
  mutate(model = "Climate Normal")%>%
  relabel_predictors(c(z.DIA_C = "DBH",                       # relabel predictors
                       "I(z.DIA_C^2)" = "DBH^2",
                       z.CR = "Crown Ratio",
                       z.ppt_pJunSep = "Precipitation",
                       z.tmax_FebJul = "Temperature",
                       "z.ppt_pJunSep:z.tmax_FebJul" = "Climate Interaction",
                       z.n_ppt = "Precip Normal",
                       z.n_tmp = "Temp Normal",
                       z.BAL = "BAL",
                       z.CCF = "CCF", 
                       z.SDI = "SDI",
                       z.SICOND = "Site Index",
                       z.SLOPE = "Slope"))
clim_n1_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep+z.tmax_pAug+
                 #z.ppt_pJunSep:z.tmax_pAug+ #significant interaction
                 #z.n_ppt+z.n_tmp+
                 z.n_tmp:z.ppt_pJunSep+
                 z.n_ppt:z.ppt_pJunSep+
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
models_n <- full_join(n_df,n_pp) %>%
  full_join(.,n_es)
dwplot(models_n, 
       vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2), 
       # plot line at zero _behind_ coefs
       dot_args = list(aes(shape = model)),
       whisker_args = list(aes(linetype = model))) +
  theme_bw() + xlab("Coefficient Estimate") + ylab("") +
  ggtitle("") +
  theme(plot.title = element_text(face="bold"),
        legend.position = "right",
        legend.background = element_rect(colour="grey80"),
        legend.title.align = 0.5)
```


## Projection...if time

I want to talk about what to do with the non-focal trees, which are used to calculate density metrics. How do we extrapolate diameter every year from `MEASYEAR` to the end of the projection?

### BAR method

The BAR method was used to back calculate diameter for non-focal trees in the calibration data set. It is found in the User's Guide to the Stand Prognosis Model (Wykoff, Crookston, Stage, pg 48)

$$BAR = DBH_0^2/DBH_1^2$$
It is use for calculating missing diameter measurements.

$$DBH_0 = sqrt(BAR * DBH_1^2)$$
We can use it to project diameter.

$$DBH_1 = sqrt((DBH_0^2)/BAR)$$
But it might be unrealistic.

### FVS method

We could also use FVS to project stand dynamics and filter for the non-focal trees. The trees' growth might be more realistic. There might be trees that die. 

We could also think about running two scenarios - a no management scenario vs a thinning treatement.

## Interpretation

How will a method influence interpretation? Projection is using different climate change scenarios. If we keep all else constant, the results will just show climate sensitivity for each species?

Example plot:
```{r echo=FALSE}
rcp85 = function(x){x*(-3) + 1}
rcp60 = function(x){x*(-2) + 1}
rcp45 = function(x){x*(-1) + 1}
rcp26 = function(x){x*0 + 1}
ggplot(data.frame(x=c(1, 50)), aes(x=x)) + 
  stat_function(fun=rcp85, aes(colour = "rcp85")) +
  stat_function(fun=rcp60, aes(colour = "rcp60")) +
  stat_function(fun=rcp45, aes(colour = "rcp45")) +
  stat_function(fun=rcp26, aes(colour = "rcp26")) +
  xlab("Years into the future") + ylab("Change in.. DBH, BA, ?") +
  scale_colour_manual("RCP", values = c("blue", "green", "orange", "red"))
```

#Test

Try climate normals with interactions

```{r}

```

```{r}
clim_rint1_pp <- lmer(log(dds)~
                     #tree variables
                     z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                     #z.CR+
                     #climate
                     z.ppt_pJunSep*z.tmax_JunAug+#interaction significant
                     #competition/density
                     z.CCF+ #remove /100 due to standardization
                     z.CCF:z.ppt_pJunSep+
                     #site variables
                     z.SICOND+
                     #random effects
                     (1+z.DIA_C|TRE_CN)+(1+z.tmax_JunAug|FVS_LOC_CD:TRE_CN)+(1|Year),
                   control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
                   data = glmm_pp_z)
clim_rint_es <- lmer(log(dds)~
                 #tree variables
                 z.DIA_C+I(z.DIA_C^2)+ #remove log due to standardization
                 z.CR+
                 #climate
                 z.ppt_pJunSep*z.tmax_pAug+ #significant interaction
                 #competition/density
                 z.BAL+#z.PCCF+z.CCF+ #remove /100 due to standardization
                 z.BAL:z.ppt_pJunSep+
                 #site variables
                 z.SICOND+z.SLOPE+
                 #random effects
                 (1+z.DIA_C|TRE_CN)+(1+z.ppt_pJunSep|FVS_LOC_CD:TRE_CN)+(1|Year),
                 control = lmerControl(optimizer = "Nelder_Mead",optCtrl = list(maxfun = 100000)),
               data = glmm_es_z)
```

